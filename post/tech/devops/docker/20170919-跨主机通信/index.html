<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Docker | è·¨ä¸»æœºé€šä¿¡ - iJayer</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="zher" /><meta name="description" content="" /><meta name="keywords" content="docker" />






<meta name="generator" content="Hugo 0.52 with even 4.0.0" />


<link rel="canonical" href="https://iJayer.github.io/post/tech/devops/docker/20170919-%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E4%BF%A1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.93844dae.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Docker | è·¨ä¸»æœºé€šä¿¡" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iJayer.github.io/post/tech/devops/docker/20170919-%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E4%BF%A1/" /><meta property="article:published_time" content="2017-09-19T16:39:25&#43;08:00"/>
<meta property="article:modified_time" content="2017-09-19T18:39:25&#43;00:00"/>

<meta itemprop="name" content="Docker | è·¨ä¸»æœºé€šä¿¡">
<meta itemprop="description" content="">


<meta itemprop="datePublished" content="2017-09-19T16:39:25&#43;08:00" />
<meta itemprop="dateModified" content="2017-09-19T18:39:25&#43;00:00" />
<meta itemprop="wordCount" content="5095">



<meta itemprop="keywords" content="docker," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Docker | è·¨ä¸»æœºé€šä¿¡"/>
<meta name="twitter:description" content=""/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">iJayer</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/categories/footprint/">
        <li class="mobile-menu-item">FootPrint</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">iJayer</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/footprint/">FootPrint</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Docker | è·¨ä¸»æœºé€šä¿¡</h1>

      <div class="post-meta">
        <span class="post-time"> 2017-09-19 </span>
        <div class="post-category">
            <a href="/categories/tech/"> tech </a>
            </div>
          <span class="more-meta"> 5095 words </span>
          <span class="more-meta"> 11 mins read </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#ç›¸å…³çŸ¥è¯†">ç›¸å…³çŸ¥è¯†</a>
<ul>
<li><a href="#overlay-network">Overlay Networkï¼Ÿ</a></li>
<li><a href="#overlayçš„ä¸»è¦æŠ€æœ¯æ ‡å‡†-vxlan">Overlayçš„ä¸»è¦æŠ€æœ¯æ ‡å‡†ï¼šVXLAN</a></li>
<li><a href="#dockerç½‘ç»œæ¶æ„å’Œlibnetwork">Dockerç½‘ç»œæ¶æ„å’Œlibnetwork</a></li>
</ul></li>
<li><a href="#ç›¸å…³æ–¹æ¡ˆç®€ä»‹">ç›¸å…³æ–¹æ¡ˆç®€ä»‹</a>
<ul>
<li><a href="#åŸºäºæ¡¥æ¥çš„è·¨ä¸»æœºé€šä¿¡">åŸºäºæ¡¥æ¥çš„è·¨ä¸»æœºé€šä¿¡</a></li>
<li><a href="#åŸºäºoverlayçš„è·¨ä¸»æœºé€šä¿¡">åŸºäºOverlayçš„è·¨ä¸»æœºé€šä¿¡</a></li>
</ul></li>
<li><a href="#åŸºäºoverlayç½‘ç»œå’Œä¸€ä¸ªå¤–éƒ¨key-valueå­˜å‚¨æ•°æ®åº“æ­å»ºdockerè·¨ä¸»æœºé€šä¿¡">åŸºäºOverlayç½‘ç»œå’Œä¸€ä¸ªå¤–éƒ¨Key-Valueå­˜å‚¨æ•°æ®åº“æ­å»ºDockerè·¨ä¸»æœºé€šä¿¡</a>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#å®éªŒç¯å¢ƒè¯´æ˜">å®éªŒç¯å¢ƒè¯´æ˜</a></li>
<li><a href="#å¯åŠ¨consulæ•°æ®åº“">å¯åŠ¨Consulæ•°æ®åº“</a></li>
<li><a href="#é…ç½®dockeræœåŠ¡">é…ç½®DockeræœåŠ¡</a></li>
</ul></li>
<li><a href="#ä¿®æ”¹-docekr-service">ä¿®æ”¹ docekr.service</a></li>
<li><a href="#ä¿®æ”¹-execstart-é€‰é¡¹å¦‚ä¸‹">ä¿®æ”¹ ExecStart é€‰é¡¹å¦‚ä¸‹</a>
<ul>
<li><a href="#åˆ›å»ºoverlayç½‘ç»œ">åˆ›å»ºOverlayç½‘ç»œ</a></li>
<li><a href="#åˆ›å»ºå®¹å™¨å¹¶æ¥å…¥overlayç½‘ç»œ">åˆ›å»ºå®¹å™¨å¹¶æ¥å…¥Overlayç½‘ç»œ</a></li>
<li><a href="#æµ‹è¯•è¿é€šæ€§">æµ‹è¯•è¿é€šæ€§</a></li>
<li><a href="#è¯¥æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜">è¯¥æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜</a>
<ul>
<li><a href="#å®¿ä¸»æœºå¦‚ä½•ç®€å•é«˜æ•ˆçš„è®¿é—®dockerè‡ªå¸¦çš„overlayç½‘ç»œä¸­çš„æ‰€æœ‰å®¹å™¨-åŒ…æ‹¬å…¶ä»–å®¿ä¸»æœºä¸Šçš„">å®¿ä¸»æœºå¦‚ä½•ç®€å•é«˜æ•ˆçš„è®¿é—®Dockerè‡ªå¸¦çš„Overlayç½‘ç»œä¸­çš„æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬å…¶ä»–å®¿ä¸»æœºä¸Šçš„ï¼‰</a></li>
</ul></li>
</ul></li>
<li><a href="#overlayç½‘ç»œå®ç°åŸç†">Overlayç½‘ç»œå®ç°åŸç†</a>
<ul>
<li><a href="#æ€»ç»“overlayç½‘ç»œ">æ€»ç»“Overlayç½‘ç»œ</a></li>
</ul></li>
<li><a href="#issue">Issue</a></li>
<li><a href="#see-also">See Also</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <!-- æ‘˜è¦ -->

<h1 id="ç›¸å…³çŸ¥è¯†">ç›¸å…³çŸ¥è¯†</h1>

<h2 id="overlay-network">Overlay Networkï¼Ÿ</h2>

<p>An overlay network is a computer network that is built on top of another network. è¦†ç›–ç½‘ç»œï¼Œæ˜¯ä¸€ä¸ªå»ºç«‹åœ¨å¦ä¸€ä¸ªç½‘ç»œä¸Šçš„è®¡ç®—æœºç½‘ç»œã€‚è¦†ç›–ç½‘ç»œä¸­çš„èŠ‚ç‚¹è¢«è®¤ä¸ºæ˜¯é€šè¿‡è™šæ‹Ÿæˆ–é€»è¾‘é“¾æ¥ç›¸è¿çš„ï¼Œå…¶ä¸­æ¯ä¸€æ¡é“¾æ¥å¯¹åº”ä¸€æ¡è·¯å¾„(PATH)ã€‚<a href="https://zh.wikipedia.org/wiki/%E8%A6%86%E7%9B%96%E7%BD%91%E7%BB%9C">Wikipedia</a> ã€<a href="http://www.h3c.com/cn/d_201309/796466_30008_0.htm">åŸºäºå¤šç§Ÿæˆ·çš„äº‘è®¡ç®—Overlayç½‘ç»œ</a></p>

<h2 id="overlayçš„ä¸»è¦æŠ€æœ¯æ ‡å‡†-vxlan">Overlayçš„ä¸»è¦æŠ€æœ¯æ ‡å‡†ï¼šVXLAN</h2>

<ul>
<li>VXLAN(Virtual Extensible LAN: è™šæ‹Ÿå¯æ‰©å±•å±€åŸŸç½‘)ï¼šæ˜¯ä¸€ç§Overlayç½‘ç»œ(åœ¨ç½‘ç»œä¹‹ä¸Šæ„å»ºçš„ä¸€å±‚ç½‘ç»œ)ï¼ŒåŸºäºéš§é“æŠ€æœ¯å®ç°ã€‚</li>
<li>Linux Bridgeé»˜è®¤æ”¯æŒVXLAN, OpenVSwitchä¹Ÿæ”¯æŒVXLAN</li>
<li>VxLan ç±»ä¼¼äº VLanæŠ€æœ¯ï¼Œæœ€å¤§çš„ä¸åŒç‚¹æ˜¯ï¼ŒVxLanå¯ä»¥æ‹¥æœ‰æ›´å¤šçš„ç½‘æ®µï¼Œè¿œè¿œå¤§äºVLançš„ç½‘æ®µã€‚ VLanåªæ”¯æŒ4094ä¸ªç½‘æ®µã€‚</li>
<li>VXLAN çš„æ•°æ®åŒ…æ˜¯å°è£…åˆ°UDPé€šè¿‡ä¸‰å±‚ç½‘ç»œè½¬å‘ï¼Œå¯ä½¿ç”¨æ‰€æœ‰çš„ç½‘ç»œè·¯å¾„; VXLANçš„ä¼ è¾“åè®®æ˜¯ IP+UDP</li>
</ul>

<h2 id="dockerç½‘ç»œæ¶æ„å’Œlibnetwork">Dockerç½‘ç»œæ¶æ„å’Œlibnetwork</h2>

<p>libnetwork æ˜¯Dockerå®¹å™¨ç½‘ç»œåº“ï¼Œæœ€æ ¸å¿ƒçš„å†…å®¹æ˜¯å…¶å®šä¹‰çš„ Container Network Model(CNM), è¿™ä¸ªæ¨¡å‹å¯¹å®¹å™¨ç½‘ç»œè¿›è¡Œäº†æŠ½è±¡</p>

<p>CNM ä¸»è¦ç”±ä»¥ä¸‹ä¸‰ç±»ç»„ä»¶æ„æˆï¼š</p>

<blockquote>
<ul>
<li><p>Sandbox(æ²™ç®±)ï¼šå®¹å™¨çš„ç½‘ç»œæ ˆï¼ŒåŒ…å«å®¹å™¨çš„Interfaceã€è·¯ç”±è¡¨å’ŒDNSè®¾ç½®ã€‚Linux Network Namespace æ˜¯sandboxçš„æ ‡å‡†å®ç°ã€‚sandboxå¯ä»¥åŒ…å«æ¥è‡ªä¸åŒNetworkçš„Endpoint</p></li>

<li><p>Endpoint(ç«¯ç‚¹)ï¼šç”¨äºå°†sandboxæ¥å…¥Networkã€‚Endpointçš„å…¸å‹å®ç°æ˜¯ veth pairã€‚ä¸€ä¸ª Endpointåªèƒ½å±äºä¸€ä¸ªç½‘ç»œï¼Œä¹Ÿåªèƒ½å±äºä¸€ä¸ªsandbox</p></li>

<li><p>Network(ç½‘ç»œ)ï¼šNetworkåŒ…å«ä¸€ç»„Endpointï¼ŒåŒä¸€Networkçš„Endpointå¯ä»¥ç›´æ¥é€šä¿¡ã€‚</p></li>
</ul>
</blockquote>

<p>æ¶æ„ç¤ºæ„å›¾:</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1548403941/blog/images/docker-net-00.png" alt="Docker-CNM" /></p>

<p>libnetworkä¸­çš„5ç§å†…ç½®é©±åŠ¨ï¼š</p>

<ul>
<li><p>bridge é©±åŠ¨ï¼šDockeré»˜è®¤çš„è®¾ç½®ï¼Œä½¿ç”¨è¿™ä¸ªé©±åŠ¨çš„æ—¶å€™ï¼Œlibnetworkå°†åˆ›å»ºå‡ºæ¥çš„Dockerå®¹å™¨é“¾æ¥åˆ°Dockerç½‘æ¡¥ä¸Šã€‚</p></li>

<li><p>host é©±åŠ¨ï¼šä½¿ç”¨è¿™ç§é©±åŠ¨çš„æ—¶å€™ï¼Œlibnetworkå°†ä¸ä¼šä¸ºDockerå®¹å™¨åˆ›å»ºç½‘ç»œåè®®æ ˆï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šåˆ›å»ºç‹¬ç«‹çš„network namespaceã€‚Dockerå®¹å™¨ä¸­çš„è¿›ç¨‹å¤„äºå®¿ä¸»æœºçš„ç½‘ç»œç¯å¢ƒä¸­ã€‚</p></li>

<li><p>overlay é©±åŠ¨ï¼šè¯¥é©±åŠ¨é‡‡ç”¨æ ‡å‡†çš„VxLANFANGSHI, å¹¶ä¸”VxLanè¢«æ™®éè®¤ä¸ºæ˜¯æœ€é€‚åˆå¤§è§„æ¨¡çš„äº‘è®¡ç®—è™šæ‹ŸåŒ–ç¯å¢ƒçš„SDN controlleræ¨¡å¼ã€‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ä¸€ä¸ª<code>é¢å¤–çš„é…ç½®å­˜å‚¨æœåŠ¡</code>ã€‚</p></li>

<li><p>remote é©±åŠ¨ï¼šè¿™ä¸ªé©±åŠ¨å¹¶æ²¡æœ‰åšçœŸæ­£çš„ç½‘ç»œå®ç°ï¼Œè€Œæ˜¯è°ƒç”¨äº†ç”¨æˆ·è‡ªè¡Œå®ç°çš„ç½‘ç»œé©±åŠ¨æ’ä»¶ï¼Œä½¿libnetworkå®ç°äº†é©±åŠ¨çš„å¯æ’ä»¶åŒ–ã€‚</p></li>

<li><p>null é©±åŠ¨ï¼šä½¿ç”¨è¿™ç§é©±åŠ¨çš„æ—¶å€™ï¼ŒDockerå®¹å™¨æ‹¥æœ‰è‡ªå·±çš„network namespaceï¼Œä½†æ˜¯ä¸ä¼šè¿›è¡Œä»»ä½•ç½‘ç»œé…ç½®ã€‚</p></li>
</ul>

<h1 id="ç›¸å…³æ–¹æ¡ˆç®€ä»‹">ç›¸å…³æ–¹æ¡ˆç®€ä»‹</h1>

<h2 id="åŸºäºæ¡¥æ¥çš„è·¨ä¸»æœºé€šä¿¡">åŸºäºæ¡¥æ¥çš„è·¨ä¸»æœºé€šä¿¡</h2>

<blockquote>
<p><a href="http://ibash.cc/frontend/article/54/">åŸºäºæ¡¥æ¥çš„è·¨ä¸»æœºé€šä¿¡</a></p>
</blockquote>

<p>ç›®å‰, Dockeré»˜è®¤ç½‘ç»œæ¨¡å¼(bridge)ä¸‹ï¼Œå•å°ä¸»æœºä¸Šçš„Dockerå®¹å™¨é—´å¯é€šè¿‡docker0ç½‘æ¡¥é€šä¿¡, è€Œä¸åŒä¸»æœºä¸Šçš„Dockerå®¹å™¨é—´åªèƒ½é€šè¿‡åœ¨ä¸»æœºä¸Šåšç«¯å£æ˜ å°„çš„æ–¹æ³•é€šä¿¡ã€‚è¿™ç§æ–¹æ¡ˆåœ¨Dockeré›†ç¾¤åº”ç”¨æ—¶å¾ˆä¸æ–¹ä¾¿, å¦‚æœå¯ä»¥ç›´æ¥ä½¿ç”¨å®¹å™¨IPè·¨ä¸»æœºé€šä¿¡åˆ™ä¼šç®€ä¾¿å¾ˆå¤šã€‚</p>

<h2 id="åŸºäºoverlayçš„è·¨ä¸»æœºé€šä¿¡">åŸºäºOverlayçš„è·¨ä¸»æœºé€šä¿¡</h2>

<blockquote>
<p>Dockeræ”¯æŒä½¿ç”¨Overlayç½‘ç»œé©±åŠ¨å®ç°è·¨ä¸»æœºç½‘ç»œé€šä¿¡</p>
</blockquote>

<p>ä¸åŒäº <code>bridge</code> ç½‘ç»œï¼Œä½¿ç”¨overlayç½‘ç»œéœ€è¦æ»¡è¶³ä¸€ä¸‹æ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼š</p>

<ul>
<li>Dockerè¿è¡Œåœ¨ swarm æ¨¡å¼</li>
<li>ä¸€ä¸ªé”®å€¼å­˜å‚¨é›†ç¾¤(ZooKeeper | etcd | consul)</li>
</ul>

<p>Note: å®˜æ–¹æ–‡æ¡£ä¸­Docker overlayç½‘ç»œæ˜¯å’ŒSwarmå…±å­˜çš„</p>

<h1 id="åŸºäºoverlayç½‘ç»œå’Œä¸€ä¸ªå¤–éƒ¨key-valueå­˜å‚¨æ•°æ®åº“æ­å»ºdockerè·¨ä¸»æœºé€šä¿¡">åŸºäºOverlayç½‘ç»œå’Œä¸€ä¸ªå¤–éƒ¨Key-Valueå­˜å‚¨æ•°æ®åº“æ­å»ºDockerè·¨ä¸»æœºé€šä¿¡</h1>

<blockquote>
<p><a href="http://ibash.cc/frontend/article/57/">å‚è€ƒæ–¹æ¡ˆÂ·Docker Overlayè·¨ä¸»æœºé€šä¿¡</a></p>
</blockquote>

<h2 id="overview">Overview</h2>

<p>ä½¿ç”¨Docker Overlayç½‘ç»œï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š</p>

<ul>
<li><p>ä¸€ä¸ªå¯è®¿é—®çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼šDockeræ”¯æŒ <code>Consul</code> ã€<code>Etcd</code>ã€<code>ZooKeeper(åˆ†å¸ƒå¼)</code>é”®å€¼å­˜å‚¨ã€‚</p></li>

<li><p>ä¸€ä¸ªDocker Hosté›†ç¾¤ï¼Œä»–ä»¬è¦é“¾æ¥åˆ°é”®å€¼å­˜å‚¨ï¼Œå¹¶ä¸”é›†ç¾¤å†…æ¯ä¸ªDocker Hostçš„ä¸»æœºåå¿…é¡»è¦å”¯ä¸€ã€‚å› ä¸ºDockerå®ˆæŠ¤è¿›ç¨‹ä¸consulé€šä¿¡æ—¶ï¼Œä¼šä»¥ä¸»æœºåç›¸äº’åŒºåˆ†ã€‚</p></li>

<li><p>é…ç½®æ­£ç¡®çš„Docker Daemonå¯åŠ¨å‚æ•°ã€‚è®©æ‰€æœ‰çš„Docker Hostéƒ½å¯ä»¥è®¿é—®é›†ç¾¤key-valueçš„æœåŠ¡ç«¯å£</p></li>
</ul>

<p>é€šè¿‡å®˜ç½‘ç»™å‡ºçš„éœ€æ±‚ï¼Œå¯ä»¥çŸ¥é“ï¼š</p>

<ul>
<li><p>Docker Daemonè¦å¼€å¯è¿œç¨‹ç®¡ç†çš„ç«¯å£(tcp xxx)ï¼Œè¿™ä¸ªç«¯å£å¯ä»¥ç”¨æ¥è¿œç¨‹ç»™Docker(æåº¦å±é™©)</p></li>

<li><p>Docker Daemonè¿˜è¦å¼€å¯ä¸€ä¸ªtcp/udpçš„7946ç«¯å£ï¼ŒDockeré€šè¿‡è¿™ä¸ªç«¯å£ï¼Œç”¨gossipåè®®å­¦ä¹ å„ä¸ªå®¿ä¸»æœºä¸Šè¿è¡Œäº†é‚£äº›å®¹å™¨ã€‚</p></li>

<li><p>VxLanæœ¬èº«ä¹Ÿéœ€è¦ä¸€ä¸ªUDPçš„4789ç«¯å£</p></li>
</ul>

<blockquote>
<p>Noteï¼šè¦åœ¨é˜²ç«å¢™å¼€å¯è¿™äº›ç«¯å£</p>
</blockquote>

<h2 id="å®éªŒç¯å¢ƒè¯´æ˜">å®éªŒç¯å¢ƒè¯´æ˜</h2>

<p>å®éªŒä¸»æœºï¼š</p>

<table>
<thead>
<tr>
<th>Host</th>
<th>OS</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>192.168.1.180</td>
<td>Centos7 Kernel 3.10.0</td>
<td>Dockerä¸»æœº_A(æ­å»ºconsulæ•°æ®åº“)</td>
</tr>

<tr>
<td>192.168.1.181</td>
<td>Centos7 Kernel 3.10.0</td>
<td>Dockerä¸»æœº_B</td>
</tr>
</tbody>
</table>

<h2 id="å¯åŠ¨consulæ•°æ®åº“">å¯åŠ¨Consulæ•°æ®åº“</h2>

<blockquote>
<p><a href="https://www.consul.io/intro/index.html">Consul çš„ç›¸å…³ä»‹ç»</a></p>
</blockquote>

<p>Consulï¼šä¸€ä¸ªç”¨äºæœåŠ¡å‘ç°å’Œé…ç½®å…±äº«çš„æœåŠ¡è½¯ä»¶ï¼Œç”±HashiCorpå…¬å¸ç”¨Goå¼€å‘ï¼›Consulæ”¯æŒå¥åº·æ£€æŸ¥ã€å¹¶å…è®¸HTTPå’ŒDNSåè®®è°ƒç”¨APIå­˜å‚¨é”®å€¼å¯¹</p>

<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨Consulæ¥ä¿å­˜Overlayçš„ç½‘ç»œçŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬Endpointã€Network &amp; IPç­‰ï¼›å½“ç„¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦å†™ä»£ç ï¼Œåªéœ€è¦å®‰è£…Consul, ä¹‹åDockerä¼šè‡ªåŠ¨è¿›è¡ŒçŠ¶æ€å­˜å‚¨ç­‰ã€‚</p>

<blockquote>
<p><a href="https://blog.coding.net/blog/intro-consul">https://blog.coding.net/blog/intro-consul</a></p>
</blockquote>

<ul>
<li>å®‰è£…Consul<br /></li>
</ul>

<p>æœ€ç®€å•çš„å®‰è£…æ–¹å¼å³è¿è¡ŒDocker.Consulå®¹å™¨å“¦, è¿™é‡Œ consul æœåŠ¡æ­å»ºåœ¨ä¸»æœºï¼š<code>192.168.1.180</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># æ‹‰å–é•œåƒ</span>
$ docker pull progrium/consul

<span class="c1"># å¯åŠ¨consulæœåŠ¡</span>
$ docker run --resatrt<span class="o">=</span>always -d -p <span class="m">8500</span>:8500 -h consul --name consul progrium/consul -server -bootstrap

<span class="c1"># æŸ¥çœ‹consulå®¹å™¨æ˜¯å¦è¿è¡ŒæˆåŠŸ</span>
docker ps </code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>å¯åŠ¨åï¼Œå¯åœ¨æµè§ˆå™¨è¾“å…¥ <code>host:port</code> å¯ä»¥çœ‹åˆ°NodesèŠ‚ç‚¹å·²ç»æ·»åŠ äº†Consulï¼›è¿™é‡Œhost:port=192.168.1.180:8500</p>
</blockquote>

<h2 id="é…ç½®dockeræœåŠ¡">é…ç½®DockeræœåŠ¡</h2>

<blockquote>
<p>Note: æ‰€æœ‰åŠ å…¥Overlayç½‘ç»œçš„Docker Hostéƒ½éœ€è¦å®Œæˆå¦‚ä¸‹é…ç½®ï¼Œä¸”æ‰€æœ‰Docker Hostä¸»æœºåå¿…é¡»å”¯ä¸€</p>
</blockquote>

<ul>
<li><p>ä¿®æ”¹Dockerå¯åŠ¨å‚æ•°
```bash</p>

<h1 id="ä¿®æ”¹-docekr-service">ä¿®æ”¹ docekr.service</h1>

<p>$ vim /usr/lib/systemd/system/docker.service</p></li>
</ul>

<h1 id="ä¿®æ”¹-execstart-é€‰é¡¹å¦‚ä¸‹">ä¿®æ”¹ ExecStart é€‰é¡¹å¦‚ä¸‹</h1>

<p>ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock &ndash;cluster-store=consul://192.168.1.180:8500 &ndash;cluster-advertise=ens33:2376</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></pre></td>
<td class="lntd">
<pre class="chroma">&gt; Note: 
&gt; 
&gt; - --cluster-store: æŒ‡å®šé”®å€¼å­˜å‚¨çš„åœ°å€(ConsulèŠ‚ç‚¹IP)
&gt; - --cluster-advertise: å‘Šè¯‰å­˜å‚¨æœåŠ¡è‡ªå·±çš„è¿æ¥åœ°å€(ens33ä¸ºdockerèŠ‚ç‚¹IPåœ°å€æ‰€åœ¨çš„ç½‘å¡å)

- é‡å¯DockeræœåŠ¡

```bash
$ systemctl daemon-reload
$ systemctl restart docker.service</pre></td></tr></table>
</div>
</div>
<ul>
<li>æŸ¥çœ‹å­˜å‚¨çš„é”®å€¼å¯¹ç»“æœ<br />
<a href="http://192.168.1.180:8500/ui/#/dc1/kv/docker/nodes/">http://192.168.1.180:8500/ui/#/dc1/kv/docker/nodes/</a></li>
</ul>

<blockquote>
<p>Note: å¯ä»¥çœ‹åˆ° docker/nodesä¸‹å·²ç»æœ‰ä¸¤ä¸ªèŠ‚ç‚¹</p>
</blockquote>

<h2 id="åˆ›å»ºoverlayç½‘ç»œ">åˆ›å»ºOverlayç½‘ç»œ</h2>

<ul>
<li>åœ¨HostA(192.168.1.180)ä¸Šåˆ›å»ºOverlayç½‘ç»œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># åˆ›å»º Overlay ç½‘ç»œ ovnet1, -d æŒ‡å®šç½‘ç»œæ¨¡å¼</span>
$ docker network create -d overlay ovnet1

<span class="c1"># åˆ›å»º Overlay ç½‘ç»œæ—¶ï¼Œ æŒ‡å®šå…¶å­ç½‘å’Œç½‘å…³</span>
$ docker network create -d overlay ovnet2 --subnet <span class="m">172</span>.19.0.0/24 --gateway <span class="m">172</span>.19.0.1</code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>Note: åœ¨ä¹‹åè¿è¡Œå®¹å™¨æ—¶æŒ‡å®š &ndash;network=ovnet1å³å¯ä½¿Overlayç½‘ç»œå†…çš„Dockerä¸»æœºå®ç°é€šä¿¡</p>
</blockquote>

<ul>
<li>åœ¨HostA(192.168.180)ä¸ŠæŸ¥çœ‹ç½‘ç»œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Lookup HostA Docker Network</span>
$ docker network ls 
NETWORK ID          NAME                DRIVER              SCOPE
2315b20ebe40        bridge              bridge              <span class="nb">local</span>
45fcb93505c0        docker_gwbridge     bridge              <span class="nb">local</span>
9ccf08201f10        host                host                <span class="nb">local</span>
e15bf8515ecd        none                null                <span class="nb">local</span>
0c7ad0717a77        ovnet1              overlay             global</code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>Note: åˆšæ‰åˆ›å»ºçš„ovnet1ç½‘ç»œä½œç”¨åŸŸ(SCOPE)æ˜¯global, è€Œå…¶ä»–ä¸ºlocal</p>
</blockquote>

<ul>
<li>åœ¨HostB(192.168.1.181)ä¸ŠæŸ¥çœ‹ç½‘ç»œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Lookup HostB Docker Network</span>
$ docker network ls 
NETWORK ID          NAME                DRIVER              SCOPE
2315b20ebe40        bridge              bridge              <span class="nb">local</span>
45fcb93505c0        docker_gwbridge     bridge              <span class="nb">local</span>
9ccf08201f10        host                host                <span class="nb">local</span>
e15bf8515ecd        none                null                <span class="nb">local</span>
0c7ad0717a77        ovnet1              overlay             global</code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>Note:</p>

<ul>
<li>æˆ‘ä»¬æ²¡æœ‰åœ¨HostBä¸Šåˆ›å»ºç½‘ç»œï¼Œè€Œè¿™é‡Œå¯ä»¥å‘ç°HostAä¸Šåˆ›å»ºçš„ç½‘ç»œ ovnet1ï¼›è¿™æ˜¯å› ä¸ºåˆ›å»ºovnet1æ—¶HostAå°†overlayçš„ç½‘ç»œä¿¡æ¯å†™å…¥äº†consulï¼Œè€ŒHostBä»consulä¸­è¯»å–åˆ°äº†ç½‘ç»œæ•°æ®å®Œæˆäº†é…ç½®; ä¹‹åovnet1çš„ä»»ä½•å˜åŒ–éƒ½ä¼šåŒæ­¥åˆ°HostAå’ŒHostB</li>
</ul>
</blockquote>

<ul>
<li>æŸ¥çœ‹ç½‘ç»œè¯¦ç»†é…ç½®</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ docker inspect ovnet1

<span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">&#34;Name&#34;</span>: <span class="s2">&#34;ovnet1&#34;</span>,
        <span class="s2">&#34;Id&#34;</span>: <span class="s2">&#34;0c7ad0717a77b329357a251f79f43f8889be819313334249be45a4f04677a0de&#34;</span>,
        <span class="s2">&#34;Created&#34;</span>: <span class="s2">&#34;2017-09-21T08:51:50.324849876+08:00&#34;</span>,
        <span class="s2">&#34;Scope&#34;</span>: <span class="s2">&#34;global&#34;</span>,
        <span class="s2">&#34;Driver&#34;</span>: <span class="s2">&#34;overlay&#34;</span>,
        <span class="s2">&#34;EnableIPv6&#34;</span>: false,
        <span class="s2">&#34;IPAM&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;Driver&#34;</span>: <span class="s2">&#34;default&#34;</span>,
            <span class="s2">&#34;Options&#34;</span>: <span class="o">{}</span>,
            <span class="s2">&#34;Config&#34;</span>: <span class="o">[</span>
                <span class="o">{</span>
                    <span class="s2">&#34;Subnet&#34;</span>: <span class="s2">&#34;10.0.0.0/24&#34;</span>,
                    <span class="s2">&#34;Gateway&#34;</span>: <span class="s2">&#34;10.0.0.1&#34;</span>
                <span class="o">}</span>
            <span class="o">]</span>
        <span class="o">}</span>,
        <span class="s2">&#34;Internal&#34;</span>: false,
        <span class="s2">&#34;Attachable&#34;</span>: false,
        <span class="s2">&#34;Ingress&#34;</span>: false,
        <span class="s2">&#34;ConfigFrom&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;Network&#34;</span>: <span class="s2">&#34;&#34;</span>
        <span class="o">}</span>,
        <span class="s2">&#34;ConfigOnly&#34;</span>: false,
        <span class="s2">&#34;Containers&#34;</span>: <span class="o">{}</span>,
        <span class="s2">&#34;Options&#34;</span>: <span class="o">{}</span>,
        <span class="s2">&#34;Labels&#34;</span>: <span class="o">{}</span>
    <span class="o">}</span>
<span class="o">]</span></code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>Note: IPAM, è¡¨ç¤ºIP Address Management</p>
</blockquote>

<h2 id="åˆ›å»ºå®¹å™¨å¹¶æ¥å…¥overlayç½‘ç»œ">åˆ›å»ºå®¹å™¨å¹¶æ¥å…¥Overlayç½‘ç»œ</h2>

<ul>
<li>åˆ›å»ºå®¹å™¨</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ docker run --name cotan1 --network ovnet1 -itd busybox</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>æŸ¥çœ‹å®¹å™¨å†…éƒ¨ç½‘ç»œ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ docker <span class="nb">exec</span> -it cotan1 sh
$ ip address

<span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN qlen <span class="m">1</span>
    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
    inet <span class="m">127</span>.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
<span class="m">16</span>: eth0@if17: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span class="m">1450</span> qdisc noqueue state UP 
    link/ether <span class="m">02</span>:42:0a:00:00:05 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">10</span>.0.0.5/24 scope global eth0
       valid_lft forever preferred_lft forever
<span class="m">26</span>: eth1@if27: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span class="m">1500</span> qdisc noqueue state UP 
    link/ether <span class="m">02</span>:42:ac:12:00:05 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">172</span>.18.0.5/16 scope global eth1
       valid_lft forever preferred_lft forever

$ ip route 

default via <span class="m">172</span>.18.0.1 dev eth1 
<span class="m">10</span>.0.0.0/24 dev eth0  src <span class="m">10</span>.0.0.5 
<span class="m">172</span>.18.0.0/16 dev eth1  src <span class="m">172</span>.18.0.5</code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>Note: å¯ä»¥çœ‹åˆ°å®¹å™¨å†…éƒ¨æœ‰ä¸¤å—ç½‘å¡ï¼Œ eth0è¿æ¥overlayç½‘ç»œï¼Œeth1è¿æ¥172.18.0.5; ä¸”é»˜è®¤è·¯ç”±æ˜¯ä»eth1ç½‘å¡å‡ºå»çš„</p>
</blockquote>

<ul>
<li>æŸ¥çœ‹å®¿ä¸»æœºç½‘æ¡¥ä¿¡æ¯</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># åœ¨HostAæ‰§è¡Œ</span>
$ ip address

<span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN qlen <span class="m">1</span>
    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
    inet <span class="m">127</span>.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
<span class="m">2</span>: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc pfifo_fast state UP qlen <span class="m">1000</span>
    link/ether <span class="m">00</span>:0c:29:c5:85:c4 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.1.180/24 brd <span class="m">192</span>.168.1.255 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::c517:b883:c99a:290c/64 scope link 
       valid_lft forever preferred_lft forever
<span class="m">3</span>: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="m">1500</span> qdisc noqueue state DOWN qlen <span class="m">1000</span>
    link/ether <span class="m">52</span>:54:00:9e:02:43 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.122.1/24 brd <span class="m">192</span>.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
<span class="m">4</span>: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu <span class="m">1500</span> qdisc pfifo_fast master virbr0 state DOWN qlen <span class="m">1000</span>
    link/ether <span class="m">52</span>:54:00:9e:02:43 brd ff:ff:ff:ff:ff:ff
<span class="m">5</span>: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP 
    link/ether <span class="m">02</span>:42:31:81:ce:4e brd ff:ff:ff:ff:ff:ff
    inet <span class="m">172</span>.18.0.1/16 scope global docker_gwbridge
       valid_lft forever preferred_lft forever
    inet6 fe80::42:31ff:fe81:ce4e/64 scope link 
       valid_lft forever preferred_lft forever
<span class="m">6</span>: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP 
    link/ether <span class="m">02</span>:42:a8:41:f3:9e brd ff:ff:ff:ff:ff:ff
    inet <span class="m">172</span>.17.0.1/16 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:a8ff:fe41:f39e/64 scope link 
       valid_lft forever preferred_lft forever
<span class="m">8</span>: veth7f764b0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue master docker0 state UP 
    link/ether <span class="m">66</span>:03:b1:8f:c2:af brd ff:ff:ff:ff:ff:ff link-netnsid <span class="m">0</span>
    inet6 fe80::6403:b1ff:fe8f:c2af/64 scope link 
       valid_lft forever preferred_lft forever</code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°å¤šäº† docker_gwbridge ç½‘å¡; ä¸”Dockerå®¹å™¨çš„eth1ç½‘å¡è¿æ¥çš„æ˜¯docker_gwbridgeç½‘æ¡¥</p>
</blockquote>

<h2 id="æµ‹è¯•è¿é€šæ€§">æµ‹è¯•è¿é€šæ€§</h2>

<ul>
<li>åœ¨HostBåˆ›å»ºå®¹å™¨</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">$ docker run --name cotan2 --network ovnet1 -itd busybox</pre></td></tr></table>
</div>
</div>
<ul>
<li>æŸ¥çœ‹å®¹å™¨IPåœ°å€å¹¶æµ‹è¯•è¿æ¥</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ docker <span class="nb">exec</span> -it cotan2 sh
$ ip address 

<span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue qlen <span class="m">1</span>
    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
    inet <span class="m">127</span>.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
<span class="m">9</span>: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span class="m">1450</span> qdisc noqueue 
    link/ether <span class="m">02</span>:42:0a:00:00:02 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">10</span>.0.0.2/24 scope global eth0
       valid_lft forever preferred_lft forever
<span class="m">13</span>: eth1@if14: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu <span class="m">1500</span> qdisc noqueue 
    link/ether <span class="m">02</span>:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">172</span>.18.0.2/16 scope global eth1
       valid_lft forever preferred_lft forever

$ ping <span class="m">10</span>.0.0.5

<span class="m">64</span> bytes from <span class="m">10</span>.0.0.2: <span class="nv">seq</span><span class="o">=</span><span class="m">0</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">0</span>.588 ms
<span class="m">64</span> bytes from <span class="m">10</span>.0.0.2: <span class="nv">seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">0</span>.417 ms
 
--- container1 ping statistics ---
<span class="m">2</span> packets transmitted, <span class="m">2</span> packets received, <span class="m">0</span>% packet loss
round-trip min/avg/max <span class="o">=</span> <span class="m">0</span>.417/0.502/0.588 ms</code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>å¯è§overlayç½‘ç»œä¸­çš„å®¹å™¨å¯ä»¥ç›´æ¥é€šä¿¡ï¼ŒåŒæ—¶Dockerä¹Ÿå®ç°äº†DNSæœåŠ¡</p>
</blockquote>

<h2 id="è¯¥æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜">è¯¥æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜</h2>

<blockquote>
<p><a href="http://www.chongchonggou.com/g_6115686.html">http://www.chongchonggou.com/g_6115686.html</a></p>
</blockquote>

<h3 id="å®¿ä¸»æœºå¦‚ä½•ç®€å•é«˜æ•ˆçš„è®¿é—®dockerè‡ªå¸¦çš„overlayç½‘ç»œä¸­çš„æ‰€æœ‰å®¹å™¨-åŒ…æ‹¬å…¶ä»–å®¿ä¸»æœºä¸Šçš„">å®¿ä¸»æœºå¦‚ä½•ç®€å•é«˜æ•ˆçš„è®¿é—®Dockerè‡ªå¸¦çš„Overlayç½‘ç»œä¸­çš„æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬å…¶ä»–å®¿ä¸»æœºä¸Šçš„ï¼‰</h3>

<p>åœ¨Dockerè‡ªå¸¦çš„Overlayç½‘ç»œä¸­ï¼Œå®¹å™¨å†…éƒ¨è®¿é—®å¤–ç½‘ä½¿ç”¨çš„æ˜¯è‡ªåŠ¨åˆ›å»ºçš„docker_gwbridgeæ¡¥ï¼Œé‚£ä¹ˆ docker å®¿ä¸»æœºå¦‚ä½•è®¿é—®overlayç½‘ç»œå†…éƒ¨å‘¢ï¼ˆæ¯”å¦‚å…¶ä»–å®¿ä¸»æœºä¸ŠåŒæ—¶åŠ å…¥è¯¥overlayç½‘ç»œçš„å®¹å™¨ï¼‰ï¼Ÿ</p>

<blockquote>
<p>è§£å†³æ–¹æ³•æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>

<ul>
<li>å°è¯•æŠŠåˆ°overlayè·¯ç”±æŒ‡åˆ°docker_gwbridgeï¼Œä½†æ˜¯æ— æ³•è®¿é—®å…¶ä»–å®¿ä¸»æœºä¸ŠåŠ å…¥åˆ°è¿™ä¸ªoverlayçš„å®¹å™¨ï¼Œå› ä¸ºæ²¡æœ‰å›ç¨‹è·¯ç”±ï¼Œç»™æ¯å°å¯åŠ¨çš„å®¹å™¨åŠ å›ç¨‹è·¯ç”±ä¹Ÿæ˜¯å¾ˆä¸ç°å®çš„ã€‚</li>
<li>å®¿ä¸»æœºä¸Šï¼Œå®¹å™¨å†…éƒ½å¼€åå‘ä»£ç†ã€‚</li>
<li>å®¹å™¨å†…å¼€å¯iptablesï¼Œåšnatã€‚</li>
<li>ä¼ ç»Ÿæ¨¡å¼ç»™å®¹å™¨åšnatæ˜ å°„å®¿ä¸»æœºç«¯å£ã€‚</li>
<li>å¦‚æœèƒ½æŒ‡å®šoverlayä¸­çš„æŸä¸ªå®¹å™¨ä¸ºæ•´ä¸ªoverlayçš„é»˜è®¤è·¯ç”±çš„è¯ï¼Œä¸€åˆ‡éƒ½å¥½åŠäº†ï¼Œå¥ˆä½•ç›®å‰åˆ°1.10.2ï¼Œgatewayéƒ½ä¼šè¢«è‡ªåŠ¨æŒ‡åˆ°æŸä¸ªç½‘æ¡¥ä¸Šï¼Œåªèƒ½æ¯å°å®¹å™¨å»ä¿®æ”¹ï¼Œä½†æ˜¯ç»™æ¯å°å®¹å™¨èµ‹äºˆè¿™ä¹ˆé«˜çš„æƒé™ï¼Œä¸ªäººæ˜¯ä¸æ„¿æ„çš„ã€‚</li>
</ul>
</blockquote>

<h1 id="overlayç½‘ç»œå®ç°åŸç†">Overlayç½‘ç»œå®ç°åŸç†</h1>

<h2 id="æ€»ç»“overlayç½‘ç»œ">æ€»ç»“Overlayç½‘ç»œ</h2>

<ul>
<li>Overlayç½‘ç»œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªdocker_gwbridgeç½‘å¡ï¼Œä½œç”¨æ˜¯ä¸ºDockerå®¹å™¨æä¾›ä¸Šå¤–ç½‘éœ€æ±‚</li>
<li>Dockerå®¹å™¨ä¸èƒ½é€šè¿‡docker_gwbridgeç½‘å¡äº’ç›¸é€šä¿¡ï¼Œå³ä½¿åœ¨åŒä¸€å°Dockerä¸»æœº, åŒä¸€ä¸ªOverlayç½‘ç»œä¹Ÿä¸è¡Œ</li>
<li>Dockerå®¹å™¨é—´é€šä¿¡åªèƒ½é€šè¿‡overlayç½‘ç»œ</li>
<li>Overlayç½‘ç»œé—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œé€šè¿‡VXLanéš”ç¦»</li>
<li>Dockerå®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ä¸Overlayç½‘ç»œçš„å‘½åç©ºé—´é€šè¿‡ä¸€å¯¹veth pairè¿æ¥èµ·æ¥</li>
<li>Dockerå®¹å™¨çš„veth pairå¯¹ç«¯veth0ä¸vxlan0è®¾å¤‡é€šè¿‡br0è¿™ä¸ªLinux bridgeæ¡¥æ¥åœ¨ä¸€èµ·ï¼Œ br0åœ¨åŒä¸€å®¿ä¸»æœºä¸Šèµ·åˆ°è™šæ‹Ÿäº¤æ¢æœºçš„ä½œç”¨ï¼Œå¦‚æœç›®æ ‡åœ°å€åœ¨åŒä¸€å®¿ä¸»æœºä¸Šï¼Œåˆ™ç›´æ¥é€šä¿¡ï¼Œå¦‚æœä¸åœ¨åˆ™é€šè¿‡è®¾ç½®vxlan0è¿™ä¸ªVXLanè®¾å¤‡è¿›è¡Œè·¨ä¸»æœºé€šä¿¡</li>
<li>Overlayç½‘ç»œç‹¬ç«‹çš„å‘½åç©ºé—´é‡Œé¢ä¼šæœ‰ä¸€ä¸ªç½‘æ¡¥br0</li>
<li>VXLan0è®¾å¤‡ä¼šåœ¨åˆ›å»ºæ—¶ï¼Œç”±Docker daemon ä¸ºå…¶åˆ†é…vxlanéš§é“IDï¼Œèµ·åˆ°ç½‘ç»œéš”ç¦»çš„ä½œç”¨</li>
<li>Docker Hosté›†ç¾¤ä¼šé€šè¿‡key/valueå­˜å‚¨å…±äº«æ•°æ®ï¼Œåœ¨7496ç«¯å£ä¸Šï¼Œäº’ç›¸ä¹‹é—´é€šè¿‡gossipåè®®å­¦ä¹ å„ä¸ªå®¿ä¸»æœºä¸Šè¿è¡Œäº†é‚£äº›å®¹å™¨ã€‚å®ˆæŠ¤è¿›ç¨‹æ ¹æ®è¿™äº›æ•°æ®åœ¨vxlan0è®¾å¤‡ä¸Šç”Ÿæˆé™æ€MACè½¬å‘è¡¨</li>
<li>æ ¹æ®é™æ€MACè½¬å‘è¡¨çš„è®¾ç½®ï¼Œé€šè¿‡UDPç«¯å£4789ï¼Œå°†æµé‡è½¬å‘åˆ°å¯¹ç«¯å®¿ä¸»æœºç½‘å¡ä¸Š</li>
<li>æ ¹æ®æµé‡åŒ…ä¸­çš„VxLanéš§é“IDï¼Œå°†æµé‡è½¬å‘åˆ°å¯¹ç«¯å®¿ä¸»æœºçš„overlayç½‘ç»œçš„ç½‘ç»œå‘½åç©ºé—´ä¸­ã€‚</li>
<li>å¯¹ç«¯å®¿ä¸»æœºçš„overlayç½‘ç»œçš„ç½‘ç»œå‘½åç©ºé—´ä¸­br0ç½‘æ¡¥ï¼Œèµ·åˆ°è™šæ‹Ÿäº¤æ¢æœºçš„ä½œç”¨ï¼Œå°†æµé‡æ ¹æ®MACåœ°å€è½¬å‘åˆ°å¯¹åº”å®¹å™¨å†…éƒ¨ã€‚</li>
</ul>

<h1 id="issue">Issue</h1>

<ul>
<li>Issue1</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@zhe0 ~<span class="o">]</span><span class="c1"># docker run --name cotan1 --network ovnet1 --ip 10.0.0.10 -d busybox</span>
402fb4295afa1fcf9ba7cc5493c9dedecf50edee1983fbbad376e8b93e560d20
docker: Error response from daemon: user specified IP address is supported only when connecting to networks with user configured subnets.</code></pre></td></tr></table>
</div>
</div>
<ul>
<li>Issue2<br />
<br /></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">åœ¨ ExecStart æœ€åæ·»åŠ : --cluster-store<span class="o">=</span>consul://&lt;consul_ip&gt;:8500 --cluster-advertise<span class="o">=</span>ens3:2376
å…¶ä¸­ è¡¨ç¤ºè¿è¡Œ consul å®¹å™¨çš„èŠ‚ç‚¹IPã€‚ens3ä¸ºå½“å‰èŠ‚ç‚¹çš„ipåœ°å€å¯¹åº”çš„ç½‘å¡</code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>æ³¨æ„ï¼š ens3æ¢æˆIPåœ°å€å¯èƒ½å¯¼è‡´å®¹å™¨è·¨ä¸»æœºé€šä¿¡å¤±è´¥</p>
</blockquote>

<h1 id="see-also">See Also</h1>

<blockquote>
<p>Thanks to the authors ğŸ™‚</p>

<ul>
<li><a href="https://docs.docker.com/engine/userguide/networking/get-started-overlay/">Official.Docs.Docker-è·¨ä¸»æœºé€šä¿¡</a></li>
<li><a href="http://www.dockone.io/article/2717">docker overlayç½‘ç»œå®ç°</a></li>
<li><a href="http://www.w2bc.com/article/261659">Dockerè·¨ä¸»æœºç½‘ç»œâ€”â€”overlay</a></li>
<li><a href="http://int32bit.me/2016/05/10/Docker%E5%AE%9E%E7%8E%B0%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E4%BF%A1/">Dockerè·¨ä¸»æœºé€šä¿¡å®ç°ä¸åˆ†æ</a></li>
<li><a href="http://dl528888.blog.51cto.com/2382721/1611491">dockeré«˜çº§åº”ç”¨ä¹‹å¤šå°ä¸»æœºç½‘ç»œäº’è”</a></li>
<li><a href="http://tonybai.com/2016/02/15/understanding-docker-multi-host-networking/">ç†è§£Dockerè·¨å¤šä¸»æœºå®¹å™¨ç½‘ç»œ</a></li>
</ul>
</blockquote>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">zher</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2017-09-19</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/tech/network/20170926-net-basic/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Network | è®¡ç®—æœºç½‘ç»œåŸºç¡€</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/tech/os/linux/20170915-linux.fedora-notes/">
            <span class="next-text nav-default">Linux | Fedora ç³»ç»Ÿä¼˜åŒ–</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2017-09-19 16:39:25 \x2b0800 CST',
        title: 'Docker | è·¨ä¸»æœºé€šä¿¡',
        clientID: '4357c1dbcf7ef0515c29',
        clientSecret: '1ad00adfd9544bff956529daf898d4b81fed2a9d',
        repo: 'blog-comments',
        owner: 'iJayer',
        admin: ['iJayer'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:zhezh.boy@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/JayerCheung" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/zhe.zh.54" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://plus.google.com/u/0/103084907763171979239" class="iconfont icon-google" title="google"></a>
      <a href="https://github.com/iJayer" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/p/1005053510554731/home?from=page_100505&amp;mod=TAB&amp;is_all=1#place" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/boy-zhe/activities" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.instagram.com/zher09/" class="iconfont icon-instagram" title="instagram"></a>
  <a href="https://iJayer.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2018 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">iJayer</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.ece58db6.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-123995495-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>

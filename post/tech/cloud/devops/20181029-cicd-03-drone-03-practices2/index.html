<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>DevOps | åŸºäº Drone CI éƒ¨ç½² Go è¯­è¨€é¡¹ç›® â€” Web Server - Zher&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="zher" /><meta name="description" content="Devops | CI/CD å®è·µ" />
<meta name="keywords" content="devops, docker, cicd" />







<meta name="generator" content="Hugo 0.46" />


<link rel="canonical" href="https://zhezh09.github.io/post/tech/cloud/devops/20181029-cicd-03-drone-03-practices2/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<script src="https://cdn.jsdelivr.net/npm/eruda@1.2.6/eruda.min.js" integrity="sha256-Jmz4bc3kp+rRrXX2tGadNBKFLwtzMapr8kHABxSAAP8=" crossorigin="anonymous"></script>
<script>eruda.init();</script>


<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="DevOps | åŸºäº Drone CI éƒ¨ç½² Go è¯­è¨€é¡¹ç›® â€” Web Server" />
<meta property="og:description" content="Devops | CI/CD å®è·µ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhezh09.github.io/post/tech/cloud/devops/20181029-cicd-03-drone-03-practices2/" />



<meta property="article:published_time" content="2018-10-29T16:58:16&#43;08:00"/>

<meta property="article:modified_time" content="2018-11-02T16:58:16&#43;00:00"/>











<meta itemprop="name" content="DevOps | åŸºäº Drone CI éƒ¨ç½² Go è¯­è¨€é¡¹ç›® â€” Web Server">
<meta itemprop="description" content="Devops | CI/CD å®è·µ">


<meta itemprop="datePublished" content="2018-10-29T16:58:16&#43;08:00" />
<meta itemprop="dateModified" content="2018-10-29T16:58:16&#43;08:00" />
<meta itemprop="wordCount" content="5369">



<meta itemprop="keywords" content="devops," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="DevOps | åŸºäº Drone CI éƒ¨ç½² Go è¯­è¨€é¡¹ç›® â€” Web Server"/>
<meta name="twitter:description" content="Devops | CI/CD å®è·µ"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Zher&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/categories/footprint/">
        <li class="mobile-menu-item">FootPrint</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Zher&#39;s Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/footprint/">FootPrint</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">DevOps | åŸºäº Drone CI éƒ¨ç½² Go è¯­è¨€é¡¹ç›® â€” Web Server</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-10-29 </span>
        <div class="post-category">
            
              <a href="/categories/tech/"> tech </a>
            
          </div>
        <span class="more-meta"> 5369 words </span>
        <span class="more-meta"> 11 mins read </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#ç®€ä»‹">ç®€ä»‹</a></li>
<li><a href="#å‡†å¤‡-go-web-app-æ¼”ç¤ºé¡¹ç›®">å‡†å¤‡ Go-Web-App æ¼”ç¤ºé¡¹ç›®</a></li>
<li><a href="#é…ç½®-drone-ci-cd-æœåŠ¡">é…ç½® Drone CI/CD æœåŠ¡</a>
<ul>
<li><a href="#drone-pipeline-å•å…ƒæµ‹è¯•-test">Drone Pipeline: å•å…ƒæµ‹è¯•(test)</a></li>
<li><a href="#drone-pipeline-æ„å»º-go-web-app-build">Drone Pipeline: æ„å»º Go-Web-App(build)</a></li>
<li><a href="#drone-pipeline-å‘å¸ƒ-docker-é•œåƒ-image">Drone Pipeline: å‘å¸ƒ Docker é•œåƒ(image)</a></li>
<li><a href="#drone-pipeline-ä¸Šä¼ é™æ€èµ„æºå’Œéƒ¨ç½²è„šæœ¬-scp">Drone Pipeline: ä¸Šä¼ é™æ€èµ„æºå’Œéƒ¨ç½²è„šæœ¬(scp)</a>
<ul>
<li><a href="#é…ç½®-docker-compose-yml">é…ç½® docker-compose.yml</a></li>
</ul></li>
<li><a href="#drone-pipeline-æœåŠ¡éƒ¨ç½²-deploy">Drone Pipeline: æœåŠ¡éƒ¨ç½²(deploy)</a></li>
<li><a href="#drone-pipeline-ç»“æœé€šçŸ¥-notify-hipchat">Drone Pipeline: ç»“æœé€šçŸ¥(notify:hipchat)</a></li>
</ul></li>
<li><a href="#see-also">See Also</a></li>
<li><a href="#faq">FAQ</a></li>
</ul>
</nav>
  </div>
</div>

    
    

    
    <div class="post-content">
      <!-- æ‘˜è¦ -->

<blockquote>
<p>å‰é¢å®Œæˆäº†åŸºç¡€è®¾æ–½æ­å»ºå’Œæµ‹è¯•ï¼Œæ¥ä¸‹æ¥å°±è¯¥å°† Drone CI/CD åº”ç”¨åˆ°é¡¹ç›®ä¸­äº†ã€‚ è¿™é‡Œæ¶‰åŠåˆ°çš„å‰å‡ ç¯‡å†…å®¹æœ‰ï¼š</p>

<ul>
<li><a href="https://zhezh09.github.io/post/tech/cloud/devops/20180925-drone-01-basic/">Drone çš„åŸºæœ¬æ¦‚å¿µ</a></li>
<li><a href="https://zhezh09.github.io/post/tech/cloud/devops/20180926-cicd-03-practices/">Drone æœåŠ¡éƒ¨ç½²</a></li>
<li><a href="https://zhezh09.github.io/post/tech/cloud/docker/docker-compose-note/">Docker-Compose åŸºç¡€</a></li>
<li><a href="https://zhezh09.github.io/post/tech/cloud/docker/registry-and-webui/">Docker Registry æœåŠ¡éƒ¨ç½²</a></li>
</ul>
</blockquote>

<p></p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1540883528/20181030-drone-cicd-pipeline-graph.png" alt="" /></p>

<h1 id="ç®€ä»‹">ç®€ä»‹</h1>

<p>è¿™é‡Œä»¥ä¸€ä¸ª Golang é¡¹ç›®(Go-Web-App)ä¸ºä¾‹ï¼ŒåŸºäº Drone CI æœåŠ¡å®Œæˆå…¶è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥ä½œæµçš„é…ç½®å’Œæ¼”ç¤ºï¼šä¸»è¦æ­¥éª¤åŒ…å«ï¼š</p>

<blockquote>
<p>clone =&gt; test =&gt; build =&gt; image =&gt; deploy =&gt; notify</p>
</blockquote>

<p>åŒ…å«å¼€å‘çš„å®Œæˆæµç¨‹è¯´æ˜ï¼š</p>

<ul>
<li>å¼€å‘é¡¹ç›®ä»£ç , åŒ…æ‹¬æºç æ–‡ä»¶ï¼Œ<code>.drone.yml</code> æ–‡ä»¶ã€Dockerfile æ–‡ä»¶ç­‰é…ç½®æ–‡ä»¶å’Œä¸€ç³»åˆ—æ‰§è¡Œè„šæœ¬(*.sh)</li>
<li>æäº¤ä»£ç ï¼š<code>push</code>ã€<code>pull request</code>ã€<code>tag</code> åˆ°ä»£ç ä»“åº“(Bitbucket Server), é€šè¿‡ Webhook è§¦å‘ Drone çš„ Pipeline</li>
<li>Drone å¼€å§‹ Pipeline çš„æ‰§è¡Œ

<ul>
<li>Clone ä»£ç è‡³å®¹å™¨(Drone é»˜è®¤æ‰§è¡Œ)</li>
<li>æ‰§è¡Œå•å…ƒæµ‹è¯•</li>
<li>ç¼–è¯‘ä»£ç ï¼Œæ„å»ºç”Ÿæˆå¯æ‰§è¡Œç¨‹åº</li>
<li>æ„å»º Docker é•œåƒï¼Œå¹¶å‘å¸ƒåˆ° Docker Registry</li>
<li>æ‰“åŒ…èµ„æºæ–‡ä»¶ã€æ‰§è¡Œè„šæœ¬ã€é…ç½®æ–‡ä»¶ç­‰åˆ°è¿œç¨‹æµ‹è¯•æœåŠ¡å™¨</li>
<li>éƒ¨ç½²åº”ç”¨å®¹å™¨åˆ°æµ‹è¯•ç¯å¢ƒ</li>
<li>ç»“æœé€šçŸ¥</li>
</ul></li>
</ul>

<blockquote>
<p>Note: Drone å¼•å…¥äº† pipeline çš„æ¦‚å¿µï¼Œä¸Šè¿°æ•´ä¸ªæ„å»ºè¿‡ç¨‹ç”±å¤šä¸ª stage ç»„æˆï¼Œæ¯ä¸€ä¸ª stage éƒ½æ˜¯åœ¨ä¸€ä¸ª Docker å®¹å™¨å†…æ‰§è¡Œ:</p>

<ul>
<li>å„ stage é—´å¯ä»¥é€šè¿‡å…±äº«å®¿ä¸»æœºçš„ç£ç›˜ç›®å½•, å®ç° build é˜¶æ®µçš„æ•°æ®å…±äº«å’Œç¼“å­˜åŸºç¡€æ•°æ®, å®ç°åŠ é€Ÿä¸‹æ¬¡ build çš„ç›®æ ‡</li>
<li>å„ stage ä¹Ÿå¯ä»¥å…±äº«å®¿ä¸»æœºçš„ docker ç¯å¢ƒï¼Œå®ç°å…±äº«å®¿ä¸»æœºçš„ docker image, ä¸ç”¨æ¯æ¬¡ build éƒ½é‡æ–°æ‹‰å– base imageï¼Œå‡å°‘ build æ—¶é—´</li>
<li>å¯ä»¥å¹¶å‘è¿è¡Œã€‚å¤šä¸ª build å¯ä»¥å¹¶å‘è¿è¡Œï¼Œå•æœºå¹¶å‘æ•°é‡ç”±æœåŠ¡å™¨ cpu æ•°å†³å®š</li>
</ul>
</blockquote>

<h1 id="å‡†å¤‡-go-web-app-æ¼”ç¤ºé¡¹ç›®">å‡†å¤‡ Go-Web-App æ¼”ç¤ºé¡¹ç›®</h1>

<p>Go-Web-App Demo Project ç®€ä»‹ï¼š</p>

<ul>
<li>ç”± Golang å®ç°ä¸€ç»„ RESTFul API</li>
<li>ç”± Gorilla Mux æä¾›è·¯ç”±</li>
<li>ç”± MongoDB æä¾›æ•°æ®å­˜å‚¨æœåŠ¡</li>
</ul>

<p>å‡†å¤‡ Go-Web-App é¡¹ç›®ï¼š</p>

<ul>
<li><p>åˆ›å»ºæºç æ ¹ç›®å½•</p>

<pre><code class="language-bash">$ cd /home/workspace/code/bitbucket/
$ mkdir goweb-app &amp;&amp; cd goweb-app
</code></pre></li>

<li><p>åˆå§‹åŒ–å·¥ç¨‹</p>

<pre><code class="language-bash">$ git init
$ touch .gitignore README.md
$ echo .idea &gt;&gt; .gitignore
$ git add --all
$ git commit -m &quot;Initial Commit&quot;
$ git remote add origin http://admin@&lt;_bitbucket_server_&gt;.com:7990/scm/sof/goweb-app.git
$ git push -u origin master
</code></pre></li>

<li><p>æ·»åŠ æºç æ–‡ä»¶</p>

<pre><code class="language-bash">$ mkdir api cicd www 
#   - cicdï¼šå­˜æ”¾ Drone CI æœåŠ¡çš„ç›¸å…³é…ç½®æ–‡ä»¶å’Œè„šæœ¬
#   - wwwï¼š å­˜æ”¾ç½‘ç«™èµ„æº
$ touch api/app.go api/model.go main.go main_test.go
</code></pre>

<ul>
<li>æºç å†…å®¹å¯ä»¥ <a href="https://github.com/zhezh09/go-practice/tree/master/go-web/restapi">Click Here</a> è¿›è¡Œæ‹·è´ã€‚</li>
</ul></li>

<li><p>åˆå§‹åŒ– go module å¹¶è¿è¡Œé¡¹ç›®</p>

<pre><code class="language-bash">$ go mod init go-web
$ go run .
go: finding github.com/gedex/inflector latest
go: finding gopkg.in/mgo.v2 latest
2018/10/31 16:03:14 mgo listen and serve on [mgo, localhost:27017]
2018/10/31 16:03:14 api listen and serve on [:8090]
</code></pre></li>

<li><p>é¡¹ç›®åˆ›å»ºå®Œæˆåå…ˆæäº¤ä»£ç åˆ°æºç åº“</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;initial project&quot; &amp;&amp; git push
</code></pre></li>
</ul>

<p>æ­¤æ—¶çš„é¡¹ç›®ç»“æ„ä¸ºï¼š</p>

<pre><code class="language-bash">goweb-app/
|-- README.md
|-- api
|   |-- app.go
|   `-- model.go
|-- go.mod
|-- go.sum
|-- main.go
`-- main_test.go

1 directory, 7 files
</code></pre>

<h1 id="é…ç½®-drone-ci-cd-æœåŠ¡">é…ç½® Drone CI/CD æœåŠ¡</h1>

<p>éœ€è¦æå‰é˜…è¯»çš„ç›¸å…³æ–‡æ¡£ï¼š</p>

<ul>
<li><a href="http://docs.drone.io/getting-started/">http://docs.drone.io/getting-started/</a></li>
<li><a href="https://zhezh09.github.io/post/tech/cloud/devops/20180925-drone-01-basic/">Drone çš„åŸºæœ¬æ¦‚å¿µ</a></li>
</ul>

<p>åœ¨é¡¹ç›® <code>æ ¹ç›®å½•</code> åˆ›å»º Drone CI/CD çš„é…ç½®æ–‡ä»¶ï¼š<code>.drone.yml</code>ï¼›ç„¶åè·³è½¬åˆ° Drone Web UIï¼š<a href="http://your_company_domain.com:8000">http://your_company_domain.com:8000</a>ï¼Œå®Œæˆç™»é™†å Drone Server ä¼šè‡ªåŠ¨åŒæ­¥ä½ çš„è´¦å·ä¸‹é¢çš„é¡¹ç›®åˆ—è¡¨(æˆ–è€…æ‰‹åŠ¨åŒæ­¥)ã€‚ç„¶åé€‰æ‹©éœ€è¦å¯ç”¨ Drone CI çš„é¡¹ç›®ï¼Œç‚¹å‡»å³ä¾§å¼€å…³é€‰é¡¹å³å¯å¯ç”¨ã€‚å¦‚ä¸‹å›¾ï¼š</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1540976956/blog/images/drone-enable-repo.png" alt="Drone UI: Repositories" /></p>

<p>æœ€åï¼Œéœ€è¦åœ¨ Drone Web UI ç®¡ç†ç•Œé¢ï¼Œæ‰¾åˆ° goweb-app çš„è®¾ç½®é€‰é¡¹ï¼Œå¼€å¯ Repo Hooksï¼Œå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1540977802/blog/images/drone-goweb-app-settings.png" alt="" /></p>

<h2 id="drone-pipeline-å•å…ƒæµ‹è¯•-test">Drone Pipeline: å•å…ƒæµ‹è¯•(test)</h2>

<p>Go-Web-App çš„æ¥å£å•å…ƒæµ‹è¯•ä¾èµ–äº MongoDB æ•°æ®åº“æœåŠ¡ï¼Œå› æ­¤åœ¨é…ç½® <code>pipeline: test</code> å‰éœ€è¦å…ˆé…ç½®å¥½ <code>services</code></p>

<ul>
<li><p>éœ€è¦æå‰é˜…è¯»çš„ç›¸å…³æ–‡æ¡£ï¼š</p>

<ul>
<li><a href="http://docs.drone.io/workspace/">Drone Docs: workspace ä»‹ç»</a></li>
<li><a href="http://docs.drone.io/services/">Drone Docs: services ä»‹ç»</a></li>
<li><a href="http://docs.drone.io/pipelines/">Drone Docs: pipelines ä»‹ç»</a></li>
<li><a href="http://docs.drone.io/mongodb-example/">Drone Docs: services mongodb ä½¿ç”¨å®ä¾‹</a></li>
<li><a href="http://docs.drone.io/pipeline-conditions/">Drone Docs: å¦‚ä½•å¯¹ pipeline åšæ¡ä»¶é™åˆ¶</a></li>
<li><a href="http://docs.drone.io/substitution/">Drone Docs: ä½¿ç”¨é¢„è®¾çš„å˜é‡åŠ¨æ€é…ç½® pipelines</a></li>
</ul></li>

<li><p>æ­¤æ—¶ <code>.drone.yml</code> é…ç½®å¦‚ä¸‹ï¼š</p>

<pre><code class="language-yml">workspace:
base: /go
path: src/repo/goweb-app

clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true

pipeline:

  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;

  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG

services:  # Dependent service
  mgo:
    image: mongo:latest

branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>workspace å®šä¹‰äº†æ‰€æœ‰å·¥ä½œæµæ­¥éª¤å…±äº«çš„å®¹å™¨ç©ºé—´å’Œç›®å½•</li>
<li>clone éƒ¨åˆ†æ˜¯é»˜è®¤é…ç½®, ä¹Ÿå¯ä»¥è‡ªå®šä¹‰</li>
<li>Pipelineï¼š<code>ping</code> stage æ”¾åœ¨ç¬¬ä¸€æ­¥æ˜¯ç”¨æ¥éªŒè¯ mgo services å·²ç»å¯ä»¥æ­£å¸¸æä¾›æœåŠ¡äº†</li>
<li>å‘½ä»¤ <code>mongo --host mgo --eval &quot;{ping:1}</code> çš„é€‰é¡¹ <code>--host</code> çš„å€¼å¡«å†™ <code>services</code> éƒ¨åˆ†é…ç½®çš„åç§°ï¼Œå³ï¼š<code>mgo</code></li>
<li>å®˜ç½‘çš„ <code>--eval &quot;{ ping: 1 }&quot;</code> ä¼šå¯¼è‡´é”™è¯¯ï¼Œéœ€æ”¹æˆ <code>--eval &quot;{ping:1}&quot;</code></li>
<li><code>${DRONE_COMMIT_BRANCH}</code> ç­‰ä¸€ç³»åˆ—é¢„è®¾å˜é‡å¯ç”¨æ¥åŠ¨æ€é…ç½® pipelines</li>
<li>commands éƒ¨åˆ†å¦‚æœå†…å®¹è¿‡å¤šæˆ–æƒ³è®© <code>.drone.yml</code> é…ç½®å˜å¾—ç®€æ´æ—¶ï¼Œå¯ç”¨è„šæœ¬å®ç°</li>
<li>services éƒ¨åˆ†ç”¨æ¥å®šä¹‰æœåŠ¡åº”ç”¨å®¹å™¨ï¼Œä¾‹å¦‚ï¼šdatabaseã€cacheã€redisç­‰</li>
<li>branches éƒ¨åˆ†å¯ä»¥ç”¨æ¥é™å®š Drone CI ä½œç”¨åœ¨é‚£äº›åˆ†æ”¯ä¸Š(è¿™é‡Œåªä½œç”¨åœ¨ï¼šmaster å’Œ release/* å¼€å¤´çš„æ‰€æœ‰åˆ†æ”¯ä¸Š)</li>
</ul>
</blockquote></li>

<li><p>æ·»åŠ è„šæœ¬ <code>test_api.sh</code>ï¼š</p>

<pre><code class="language-bash"># è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œåˆ›å»º cicd ç›®å½•ç”¨æ¥å­˜æ”¾ Drone æ‰§è¡Œæ—¶çš„ä¸€äº›è„šæœ¬å’Œé…ç½®æ–‡ä»¶
$ cd goweb-app &amp;&amp; mkdir cicd

# åˆ›å»º test_api.sh
$ touch test_api.sh 

# è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š

#!/bin/sh
#
# Program: API å•å…ƒæµ‹è¯•è„šæœ¬
# Authors: zhangzhe
# History:
#   2018-10-24ï¼šç¼–å†™è„šæœ¬å®ç°
#

# Pre Set
set -x

# Set ENV
export GO111MODULE=on                               # Go1.11.x ç‰ˆæœ¬éœ€è¦å¼€å¯
export http_proxy=http://10.0.0.121:1080
export https_proxy=${http_proxy}

# Set Var
Src=../                                             # ç¨‹åºæºç 
DB=$1                                               # Database Server Address
if [ -z $1 ]; then
    DB=mgo:27017
fi

# Golang Test
echo Test Info: $@                                  # æ‰“å°æ„å»ºä¿¡æ¯, è„šæœ¬æ‰§è¡Œå‚æ•°
                                                    # ${DRONE_COMMIT_BRANCH}
                                                    # ${DRONE_COMMIT_SHA:0:8}
                                                    # ${DRONE_BUILD_EVENT}
                                                    # ${DRONE_COMMIT_MESSAGE}
                                                    # ${DRONE_TAG}
echo $PWD

go mod tidy                                         # è§£å†³ä¾èµ–åŒ…
go test -v --cover ${Src} --db_addr=${DB}           # 'mgo:27017' Drone æä¾›çš„æ•°æ®åº“æœåŠ¡
                                                    # 'localhost:27017' å®¿ä¸»æœºæä¾›çš„æ•°æ®åº“æœåŠ¡
</code></pre></li>

<li><p>Now, æäº¤ä»£ç è¿›è¡Œæµ‹è¯•(å¤‡æ³¨ï¼šDrone CI/CD è®¾å®šåªåœ¨ master å’Œ ä»¥ release/ å¼€å¤´çš„åˆ†æ”¯èµ·ä½œç”¨)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; test stage&quot; &amp;&amp; git push
</code></pre></li>

<li><p>æ„å»ºç»“æœå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1540979214/blog/images/drone-goweb-app-pipeline-test-stage.png" alt="" /></p></li>
</ul>

<h2 id="drone-pipeline-æ„å»º-go-web-app-build">Drone Pipeline: æ„å»º Go-Web-App(build)</h2>

<p>å•å…ƒæµ‹è¯•æ‰§è¡Œå®Œæˆåï¼Œå°±å¯ä»¥è¿›å…¥ <code>build</code> é˜¶æ®µæ¥æ„å»ºå¯æ‰§è¡Œç¨‹åºäº†ã€‚</p>

<ul>
<li><p>æ­¤æ—¶çš„ <code>.drone.yml</code> é…ç½®å¦‚ä¸‹ï¼š</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/repo/goweb-app
    
clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true
    
pipeline:
  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;
      
  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG
    
    + build:  # Build go app and package source files
    +   image: golang:latest
    +   commands:
    +     - cd cicd
    +     - /bin/sh build_app.sh
    
services:  # Dependent service
  mgo:
    image: mongo:latest
    
branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre></li>

<li><p>æ„å»ºå¯æ‰§è¡Œç¨‹åºçš„å…·ä½“æ­¥éª¤ç”±è„šæœ¬ï¼šbuild_app.sh å®šä¹‰ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash"># è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œåˆ›å»º cicd ç›®å½•ç”¨æ¥å­˜æ”¾ Drone æ‰§è¡Œæ—¶çš„ä¸€äº›è„šæœ¬å’Œé…ç½®æ–‡ä»¶
$ cd cicd

# åˆ›å»º build_app.sh
$ touch build_app.sh 

# è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼š

#!/bin/sh
#
# Program: æ„å»º Go-App &amp; æ‰“åŒ…èµ„æºæ–‡ä»¶
# Authors: zhangzhe
# History:
#   2018-10-24ï¼šç¼–å†™è„šæœ¬å®ç°
#

# Pre Set
set -x

# Set ENV
export GO111MODULE=on                               # Go1.11.x ç‰ˆæœ¬éœ€è¦å¼€å¯
export http_proxy=http://10.0.0.121:1080
export https_proxy=${http_proxy}

# Set Var
Src=../                                             # ç¨‹åºæºç 
Out=&quot;app&quot;
Options=&quot;-a -installsuffix cgo -o&quot;
# PreSet='GOOS=linux GOARCH=amd64'                  # æ„å»ºå˜é‡è®¾ç½®

# Build
go version
go env

CGO_ENABLED=0 go build -o ${Out} ${Src}             # build

# Package
tar -zcvf release.tar.gz ../www ./*
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>build_app.sh è„šæœ¬çš„æœ€åä¸€è¡Œç”¨æ¥æ‰“åŒ…èµ„æºæ–‡ä»¶(ç½‘ç«™èµ„æºã€é…ç½®æ–‡ä»¶å’Œè„šæœ¬ç­‰)ï¼Œè¯¥èµ„æºæ–‡ä»¶æœ€ç»ˆéœ€è¦ä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨</li>
</ul>
</blockquote></li>

<li><p>æœ€åï¼Œåœ¨åˆ›å»º <code>www</code> ç›®å½•ç”¨æ¥æµ‹è¯•é™æ€é¡µé¢ï¼š</p>

<pre><code class="language-bash"># è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œåˆ›å»º www ç›®å½•
$ cd goweb-app &amp;&amp; mkdir www

# åˆ›å»º index.html é™æ€é¡µé¢
$ touch www/index.html

# å¡«å…¥å¦‚ä¸‹å†…å®¹ï¼š
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;

&lt;h1&gt;I'm zher.&lt;/h1&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre></li>

<li><p>Now, æäº¤ä»£ç è¿›è¡Œæµ‹è¯•(å¤‡æ³¨ï¼šDrone CI/CD è®¾å®šåªåœ¨ master å’Œ ä»¥ release/ å¼€å¤´çš„åˆ†æ”¯èµ·ä½œç”¨)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; build stage&quot; &amp;&amp; git push
</code></pre></li>

<li><p>æ„å»ºç»“æœå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541037152/blog/images/drone-goweb-app-pipeline-build-stage.png" alt="" /></p></li>
</ul>

<h2 id="drone-pipeline-å‘å¸ƒ-docker-é•œåƒ-image">Drone Pipeline: å‘å¸ƒ Docker é•œåƒ(image)</h2>

<p>è¿™é‡Œ Docker é•œåƒæ˜¯å‘å¸ƒåˆ°è‡ªå»ºçš„ Docker Registry Server çš„ï¼Œå…¶éƒ¨ç½²æ–‡æ¡£å‚è€ƒï¼š<a href="https://zhezh09.github.io/post/tech/cloud/docker/registry-and-webui/">Docker | Deploy Docker Registry and Web UI</a></p>

<ul>
<li><p>ç”Ÿæˆ Go-Web-App çš„å¯æ‰§è¡Œæ–‡ä»¶åï¼Œå°±å¯ä»¥å°†å…¶æ‰“åŒ…ä¸º Docker Image å‘å¸ƒäº†ï¼Œæ­¤æ—¶çš„ <code>.drone.yml</code> é…ç½®å¦‚ä¸‹ï¼š</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/repo/goweb-app

clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true

pipeline:

  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;

  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG

  build:  # Build go app and package source files
    image: golang:latest
    commands:
      - cd cicd
      - /bin/sh build_app.sh

    +  image:  # Build image and publish to private registry
    +    image: plugins/docker
    +    repo: repo.company.com:5000/go-app
    +    registry: repo.company.com:5000
    +    secrets: [ docker_username, docker_password ]
    +    context: ./cicd/
    +    dockerfile: ./cicd/Dockerfile
    +    default_tags: true
    +    when:
    +      event: tag

services:  # Dependent service
  mgo:
    image: mongo:latest

branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li><p>image é˜¶æ®µä½¿ç”¨äº†æ’ä»¶ï¼š<a href="http://plugins.drone.io/drone-plugins/drone-docker/">plugins/docker</a> æ¥æ„å»º Docker Image ä¸”å°†å…¶å‘å¸ƒåˆ°æŒ‡å®šçš„è¿œç¨‹ Docker Registry, è¯¦ç»†è¯´æ˜å¯ä»¥æŸ¥é˜…å…¶æ–‡æ¡£</p></li>

<li><p>image é˜¶æ®µé™åˆ¶åªåœ¨ <code>tag</code> äº‹ä»¶è¢«è§¦å‘å¼æ‰æ‰§è¡Œ Docker Image æ„å»ºå’Œå‘å¸ƒ</p></li>

<li><p>secrets é€‰é¡¹ä¸­çš„ <code>docker_username &amp; docker_password</code> æ˜¯ Drone æ³¨å…¥çš„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æå‰åœ¨ Drone Web ç«¯å…ˆè®¾ç½®å¥½è¿™äº› secretsï¼Œå¦‚ä¸‹å›¾ï¼š</p></li>
</ul>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541038364/blog/images/drone-goweb-app-secrets-0.png" alt="" /></p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541037862/blog/images/drone-goweb-app-secrets-1.png" alt="" /></p>
</blockquote></li>

<li><p>æ„å»ºé•œåƒçš„ Dockerfile å†…å®¹å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash"># è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œåˆ›å»º cicd ç›®å½•ç”¨æ¥å­˜æ”¾ Drone æ‰§è¡Œæ—¶çš„ä¸€äº›è„šæœ¬å’Œé…ç½®æ–‡ä»¶
$ cd cicd

# åˆ›å»º Dockerfile
$ touch Dockerfile

# å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š
</code></pre>

<pre><code class="language-Dockerfile"># Program: Dockerfile for API Service
# Build:
#   docker build -t &lt;image_name&gt; .

# åŸºç¡€é•œåƒ
# Usage: FROM image:tag
FROM repo.company.com:5000/alpine:3.8
    
# è®¾ç½®ç¯å¢ƒå˜é‡
# Usage: ENV &lt;key=value&gt; &lt;key=value&gt;
ENV WorkDir=/home/api

# æŒ‡å®šç»´æŠ¤è€…ä¿¡æ¯
# Usage: MAINTAINER name
MAINTAINER &lt;xxx@xxx.com&gt;

# ç»™é•œåƒæ·»åŠ å·¥ä½œç›®å½•
# Usage: RUN [å‘½ä»¤]
# RUN mkdir -p ${WorkDir}}
# Set Time Zone
RUN echo 'http://mirrors.ustc.edu.cn/alpine/v3.5/main' &gt; /etc/apk/repositories \
    &amp;&amp; echo 'http://mirrors.ustc.edu.cn/alpine/v3.5/community' &gt;&gt; /etc/apk/repositories \
    &amp;&amp; apk update &amp;&amp; apk add tzdata \
    &amp;&amp; ln -sf /usr/share/zoneinfo/Asia/Shanghai/etc/localtime \
    &amp;&amp; echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone

# è®¾å®šé»˜è®¤å·¥ä½œè·¯å¾„
# Usage: WORKDIR [path]
WORKDIR ${WorkDir}

# å¤åˆ¶æœ¬åœ°åº”ç”¨ç¨‹åºæ–‡ä»¶[src]åˆ°Containerçš„å·¥ä½œç›®å½•[dst]
# Usage: COPY [src] [dst]
COPY app ${WorkDir}/

RUN chmod +x ${WorkDir}/app
        
# å®¹å™¨æš´æ¼ç»™å¤–ä¾§çš„ç«¯å£å·
# Usage: EXPOSE port [port...]
EXPOSE 80

# æŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤
# Usage: CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]
CMD [&quot;./app&quot;]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>Dockerfile ä¸­çš„åŸºç¡€é•œåƒä½¿ç”¨çš„æ˜¯ alpine, è¿™é‡Œå°† alpine:3.8 ä¸Šä¼ åˆ°æˆ‘ä»¬è‡ªå»ºçš„ Docker Registry ä»¥èŠ‚çœæ„å»ºæ—¶é—´ã€‚å¦‚æœä½¿ç”¨ Docker Hub ä¸­çš„é•œåƒæ¯æ¬¡éƒ½è¦æ‹‰å–ä¸€æ¬¡ï¼Œä¼šå¾ˆæ…¢ã€‚</li>
</ul>
</blockquote></li>

<li><p>ä¸Šä¼ æ„å»º Go-Web-App çš„åŸºç¡€é•œåƒåˆ°æˆ‘ä»¬è‡ªå»ºçš„ Docker Private Registry:</p>

<ul>
<li><p><a href="https://zhezh09.github.io/post/tech/cloud/docker/registry-and-webui/#æµ‹è¯•">ä¸Šä¼ é•œåƒåˆ° Docker Registry å‚è€ƒæ–‡ç« </a></p>

<pre><code class="language-bash">$ docker pull alpine:3.8
$ docker tag alpine:3.8 repo.company.com:5000/alpine:3.8
$ docker push repo.company.com:5000/alpine:3.8

# push å¤±è´¥æ—¶ï¼Œå°è¯•é‡æ–°ç™»é™†åç»§ç»­ push å³å¯
</code></pre>

<p>Push <code>repo.company.com:5000/alpine:3.8</code> æˆåŠŸåï¼Œå¯ä»¥æ‰“å¼€ Docker Registry UI (<a href="http://your_domain.com:5001">http://your_domain.com:5001</a>) å³å¯çœ‹åˆ°åˆšåˆšæäº¤çš„é•œåƒä¿¡æ¯ã€‚</p></li>
</ul></li>

<li><p>Now, æäº¤ä»£ç è¿›è¡Œæµ‹è¯•(å¤‡æ³¨ï¼šDrone CI/CD è®¾å®šåªåœ¨ master å’Œ ä»¥ release/ å¼€å¤´çš„åˆ†æ”¯èµ·ä½œç”¨)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; publish image stage&quot; &amp;&amp; git push

# æ‰“ tag, è§¦å‘ when: [event: tag] äº‹ä»¶ï¼Œå³è§¦å‘ publish_image é˜¶æ®µæ‰§è¡Œ
$ git tag 0.0.1 -m &quot;release 0.0.1&quot; &amp;&amp; git push origin 0.0.1
</code></pre></li>

<li><p>æ„å»ºç»“æœå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541079815/blog/images/drone-goweb-app-pipeline-publish-image-stage.png" alt="" /></p>

<ul>
<li>æ‰§è¡Œå®Œæˆåå¯ä»¥æ‰“å¼€ Docker Registry UIï¼š<a href="http://your.domain.com:5001">http://your.domain.com:5001</a> çœ‹åˆ°åˆšåˆšæ„å»ºå¥½çš„é•œåƒ</li>
</ul>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541080216/blog/images/docker-registry-ui-1.png" alt="" /></p></li>
</ul>

<h2 id="drone-pipeline-ä¸Šä¼ é™æ€èµ„æºå’Œéƒ¨ç½²è„šæœ¬-scp">Drone Pipeline: ä¸Šä¼ é™æ€èµ„æºå’Œéƒ¨ç½²è„šæœ¬(scp)</h2>

<p>è¦å®ç°è‡ªåŠ¨éƒ¨ç½²å®¹å™¨æœåŠ¡ï¼Œå…‰æœ‰é•œåƒæ˜¯ä¸å¤Ÿçš„ï¼Œå› æ­¤ï¼Œè¿˜éœ€è¦å°†ç½‘ç«™èµ„æºï¼Œé…ç½®æ–‡ä»¶ç­‰ä¸€äº›è„šæœ¬æ‰“åŒ…å‘åˆ°è¿œç«¯æœåŠ¡å™¨ä¸Š.</p>

<ul>
<li><p>æ­¤æ—¶çš„ <code>.drone.yml</code> é…ç½®å¦‚ä¸‹ï¼š</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/repo/goweb-app

clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true

pipeline:

  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;

  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG

  build:  # Build go app and package source files
    image: golang:latest
    commands:
      - cd cicd
      - /bin/sh build_app.sh

  image:  # Build image and publish to private registry
    image: plugins/docker
    repo: repo.company.com:5000/go-app
    registry: repo.company.com:5000
    secrets: [ docker_username, docker_password ]
    context: ./cicd/
    dockerfile: ./cicd/Dockerfile
    default_tags: true
    when:
      event: tag

    +  scp:    # Upload resource and config files to remote server
    +    image: appleboy/drone-scp
    +    group: build
    +    host:
    +      - your_server_address
    +    username: root
    +    port: 22
    +    secrets: [ ssh_password ]
    +    target: /home/workspace/service/api-server # è¿œç¨‹æœåŠ¡å™¨ç›®å½•
    +    source: ./cicd/release.tar.gz              # æ‰“åŒ…å¥½çš„æ–‡ä»¶
    +    when:
    +      event: tag

services:  # Dependent service
  mgo:
    image: mongo:latest

branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>é¢„è®¾å˜é‡ <code>ssh_password</code> ä¹Ÿéœ€è¦æå‰åœ¨ Drone Web ç«¯è®¾ç½®å¥½</li>
</ul>
</blockquote></li>

<li><p>éƒ¨ç½²è„šæœ¬ <code>deploy_services.sh</code> å†…å®¹å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash"># è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œåˆ›å»º cicd ç›®å½•ç”¨æ¥å­˜æ”¾ Drone æ‰§è¡Œæ—¶çš„ä¸€äº›è„šæœ¬å’Œé…ç½®æ–‡ä»¶
$ cd cicd

# åˆ›å»ºéƒ¨ç½²è„šæœ¬ï¼šdeploy_services.sh
$ touch deploy_services.sh

# å¡«å…¥å¦‚ä¸‹å†…å®¹ï¼š

#!/bin/sh
#
# Program: éƒ¨ç½² Docker å®¹å™¨æœåŠ¡
# Authors: zhangzhe
# History:
#   2018-10-24ï¼šç¼–å†™è„šæœ¬å®ç°
#

# Pre Set
set -x

# Set Var
Tag=$1                                    # è¯»å– git tag (ç‰ˆæœ¬å·ï¼šx.y.z)
Commit=$2                                 # è¯»å– git commit å·(8ä½)

if [ -z ${Tag} ]; then
    echo -e &quot;Empty git tag given&quot;
    exit 1
fi

ImageName=go-app:${Tag}                   # é•œåƒå
Registry=develop.robot-qixing.com:5000    # ç§æœ‰ä»“åº“åœ°å€
BaseImage=${Registry}/${ImageName}        # è¿œç¨‹ Image åœ°å€ï¼šdocker pull ${BaseImage}
ContainerName=api${Tag}

# Reconfigure docker-compose.yml &amp; Caddyfile
sed -i &quot;s/api(@tag)/${ContainerName}/g&quot; docker-compose.yml  # å¯åŠ¨å¯¹åº”ç‰ˆæœ¬(Tag)çš„ API å®¹å™¨
sed -i &quot;s/(@tag)/${Tag}/g&quot; dockere-compose.yml              # æ‹‰å»å¯¹åº”ç‰ˆæœ¬(Tag)çš„ API é•œåƒ
sed -i &quot;s/api(@tag)/${ContainerName}/g&quot; Caddyfile           # Caddy ä»£ç†åˆ°å¯¹åº”ç‰ˆæœ¬çš„ API å®¹å™¨æœåŠ¡

# Pull image and run docker container
docker pull ${BaseImage}
docker-compose up -d
docker ps
docker-compose logs caddy
docker-compose logs mgo
docker logs api${Tag}
</code></pre></li>
</ul>

<h3 id="é…ç½®-docker-compose-yml">é…ç½® docker-compose.yml</h3>

<ul>
<li><p>å¼€å§‹ä¹‹å‰éœ€è¦é˜…è¯»çš„ç›¸å…³æ–‡æ¡£ï¼š</p>

<ul>
<li><a href="https://zhezh09.github.io/post/tech/cloud/docker/docker-compose-note/">Docker-Compose åŸºç¡€</a></li>
<li><a href="https://hub.docker.com/r/abiosoft/caddy/">https://hub.docker.com/r/abiosoft/caddy/</a></li>
<li><a href="https://hub.docker.com/r/library/mongo/">https://hub.docker.com/r/library/mongo/</a></li>
</ul></li>

<li><p>docker-compose.yml é…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">$ cd cicd &amp;&amp; touch docker-compose.yml

# å¡«å…¥å¦‚ä¸‹å†…å®¹
</code></pre>

<pre><code class="language-yml">version: '3'
services:
  caddy: # caddy proxy server
    container_name: caddy
    image: abiosoft/caddy:latest
    restart: always
    ports:
      - 80:80
      - 443:443
    volumes:
      - /etc/ssl/server-certs:/root/.caddy
      - ./Caddyfile:/etc/Caddyfile
      - ./www:/srv
    depends_on:
      - api

  api:  # api server
    container_name: api(@tag)
    image: repo.company.com:5000/go-app:(@tag)
    restart: always
    command: './app --port=80 --db_addr=mgo:27017'
    depends_on:
      - mgo

  mgo:  # mgo server
    container_name: mgo
    image: mongo:latest
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: &lt;__input_username__&gt;
      MONGO_INITDB_ROOT_PASSWORD: &lt;__input_password__&gt;
    volumes:
      - ./mgo-data/db:/data/db
</code></pre></li>

<li><p>Caddyfile é…ç½®å†…å®¹å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">$ cd cicd &amp;&amp; touch Caddyfile.yml

# å¡«å…¥å¦‚ä¸‹å†…å®¹
</code></pre>

<pre><code class="language-Caddyfile">https://company-domain.com {
    gzip
    root /srv
    tls /root/.caddy/cert.crt /root/.caddy/cert.key
    timeouts none

    proxy /v0 api(@tag):80 {
        transparent
        websocket
        except static
    }

    cors /v0 {
        origin            *
        methods           POST,GET,PATCH,DELETE,OPTIONS
        allow_credentials false
        max_age           3600
        allowed_headers   content-type,Authorization
        exposed_headers   X-Something-Special,SomethingElse,Authorization
    }
}
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>docker-compose.yml å’Œ Caddyfile æ–‡ä»¶ä¸­çš„ <code>(@tag)</code> å­—æ®µæœ€ç»ˆä¼šè¢« ${DRONE_TAG} æ›¿ä»£ä»¥ç”Ÿæˆå¯¹åº”ç‰ˆæœ¬çš„åº”ç”¨å®¹å™¨æœåŠ¡<br /></li>

<li><p>é€šè¿‡ docker-compose é…ç½® api serverã€caddy serverã€mongo server çš„å‚è€ƒé“¾æ¥æœ‰ï¼š</p>

<ul>
<li><a href="https://gist.github.com/wesleybliss/29d4cce863f5964a3eb73c42501d99e4">Mongo: Docker Compose with example App &amp; Mongo</a></li>
<li><a href="https://github.com/tinrab/go-mongo-docker-example/blob/master/docker-compose.yaml">Mongo: go-mongo-docker-example</a></li>
<li><a href="https://gist.github.com/abiosoft/92fa7575d255ef49ec614485e78ed3c5">Caddy: Caddy wordpress docker-compose</a></li>
<li><a href="https://caddy.community/t/docker-compose-localhost-502-error/4184">Caddy: Docker compose localhost 502 error</a></li>
<li><a href="https://caddy.community/t/solved-how-to-configure-caddy-in-docker-container-getting-permission-denied/2076">Caddy: [SOLVED] How to Configure Caddy in Docker Container (Getting Permission Denied)</a></li>
<li><a href="https://github.com/gitlabhq/gitlab-recipes/issues/311">Caddy: Caddy recipe does not work using docker-compose.yml configuration</a></li>
<li><a href="https://gist.github.com/varavut/bb516ca395d85261cb2fe0c8f080c647">Caddy: caddy-part3-docker-compose.yml</a></li>
</ul></li>
</ul>
</blockquote></li>

<li><p>Now, æäº¤ä»£ç è¿›è¡Œæµ‹è¯•(å¤‡æ³¨ï¼šDrone CI/CD è®¾å®šåªåœ¨ master å’Œ ä»¥ release/ å¼€å¤´çš„åˆ†æ”¯èµ·ä½œç”¨)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; scp stage&quot; &amp;&amp; git push

# æ‰“ tag, è§¦å‘ when: [event: tag] äº‹ä»¶ï¼Œå³è§¦å‘ publish_image é˜¶æ®µæ‰§è¡Œ
$ git tag 0.0.2 -m &quot;release 0.0.2&quot; &amp;&amp; git push origin 0.0.2
</code></pre></li>

<li><p>æ„å»ºç»“æœå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541124663/blog/images/drone-goweb-app-pipeline-scp-stage.png" alt="" /></p></li>
</ul>

<h2 id="drone-pipeline-æœåŠ¡éƒ¨ç½²-deploy">Drone Pipeline: æœåŠ¡éƒ¨ç½²(deploy)</h2>

<p>ä¸€åˆ‡å‡†å¤‡å¥½åï¼Œå°±å¯ä»¥æ‰§è¡Œå®¹å™¨æœåŠ¡éƒ¨ç½²äº†ï¼Œä¸»è¦åŒ…æ‹¬ï¼šCaddy Server Containerã€Go Web Server Containerã€MongoDB Server Containerï¼Œè¿™ä¸€ç»„åº”ç”¨å®¹å™¨æœåŠ¡é€šè¿‡ docker-compose è¿›è¡Œç®¡ç†å’Œç»„ç»‡ã€‚</p>

<ul>
<li><p>æ­¤æ—¶çš„ <code>.drone.yml</code> é…ç½®å¦‚ä¸‹ï¼š</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/repo/goweb-app
    
clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true
    
pipeline:
    
  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;
    
  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG
    
  build:  # Build go app and package source files
    image: golang:latest
    commands:
      - cd cicd
      - /bin/sh build_app.sh
    
  image:  # Build image and publish to private registry
    image: plugins/docker
    repo: repo.company.com:5000/go-app
    registry: repo.company.com:5000
    secrets: [ docker_username, docker_password ]
    context: ./cicd/
    dockerfile: ./cicd/Dockerfile
    default_tags: true
    when:
      event: tag
    
  scp:    # Upload resource and config files to remote server
    image: appleboy/drone-scp
    group: build
    host:
      - your_server_address
    username: root
    port: 22
    secrets: [ ssh_password ]
    target: /home/workspace/service/api-server # è¿œç¨‹æœåŠ¡å™¨ç›®å½•
    source: ./cicd/release.tar.gz              # éšé•œåƒä¸€èµ·å‘å¸ƒçš„æ–‡ä»¶
    when:
      event: tag
    
    +  deploy: # Deploy api-server, caddy-server, mgo-server
    +    image: appleboy/drone-ssh
    +    host:
    +      - your_server_address
    +    username: root
    +    port: 22
    +    secrets: [ ssh_password ]
    +    command_timeout: 60
    +    script:
    +      - cd /home/workspace/service/api-server/cicd
    +      - tar -zxvf release.tar.gz
    +      - ls -l
    +      - /bin/sh deploy_services.sh ${DRONE_TAG} ${DRONE_COMMIT_SHA:0:8}
    +    when:
    +      event: tag
    
services:  # Dependent service
  mgo:
    image: mongo:latest
    
branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>Drone Plugins: appleboy/drone-ssh ç”¨æ¥è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨</li>
<li>deploy_services.sh æ˜¯æ‰§è¡ŒæœåŠ¡éƒ¨ç½²çš„è„šæœ¬ï¼Œéœ€è¦æ¥æ”¶ ${DRONE_TAG} ç”¨æ¥åŠ¨æ€æ„å»ºå®¹å™¨åç§°ç­‰</li>
</ul>
</blockquote></li>

<li><p>Now, æäº¤ä»£ç è¿›è¡Œæµ‹è¯•(å¤‡æ³¨ï¼šDrone CI/CD è®¾å®šåªåœ¨ master å’Œ ä»¥ release/ å¼€å¤´çš„åˆ†æ”¯èµ·ä½œç”¨)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; deploy stage&quot; &amp;&amp; git push

# æ‰“ tag, è§¦å‘ when: [event: tag] äº‹ä»¶ï¼Œå³è§¦å‘ publish_image é˜¶æ®µæ‰§è¡Œ
$ git tag 0.0.3 -m &quot;release 0.0.3&quot; &amp;&amp; git push origin 0.0.3
</code></pre></li>

<li><p>æ„å»ºç»“æœå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541125010/blog/images/drone-goweb-app-pipeline-deploy-stage.png" alt="" /></p></li>
</ul>

<h2 id="drone-pipeline-ç»“æœé€šçŸ¥-notify-hipchat">Drone Pipeline: ç»“æœé€šçŸ¥(notify:hipchat)</h2>

<p>ä¸ºäº†ç¡®ä¿èƒ½å¤ŸåŠæ—¶è·å– Drone CI æ„å»ºç»“æœï¼Œéœ€è¦é€‰å–ä¸€ç§åˆé€‚çš„æ–¹å¼æ¥æ¥æ”¶é€šçŸ¥ï¼Œè¿™é‡Œé›†æˆäº†æˆ‘ä»¬åœ¨ç”¨çš„ hipchat.</p>

<ul>
<li><p>æ­¤æ—¶çš„ <code>.drone.yml</code> é…ç½®å¦‚ä¸‹ï¼š</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/repo/goweb-app
    
clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true
    
pipeline:
    
  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;
    
  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG
    
  build:  # Build go app and package source files
    image: golang:latest
    commands:
      - cd cicd
      - /bin/sh build_app.sh
    when:
      event: tag
    
  image:  # Build image and publish to private registry
    image: plugins/docker
    repo: repo.company.com:5000/go-app
    registry: repo.company.com:5000
    secrets: [ docker_username, docker_password ]
    context: ./cicd/
    dockerfile: ./cicd/Dockerfile
    default_tags: true
    when:
      event: tag
    
  scp:    # Upload resource and config files to remote server
    image: appleboy/drone-scp
    group: build
    host:
      - your_server_address
    username: root
    port: 22
    secrets: [ ssh_password ]
    target: /home/workspace/service/api-server # è¿œç¨‹æœåŠ¡å™¨ç›®å½•
    source: ./cicd/release.tar.gz              # éšé•œåƒä¸€èµ·å‘å¸ƒçš„æ–‡ä»¶
    when:
      event: tag
    
  deploy: # Deploy api-server, caddy-server, mgo-server
    image: appleboy/drone-ssh
    host:
      - your_server_address
    username: root
    port: 22
    secrets: [ ssh_password ]
    command_timeout: 60
    script:
      - cd /home/workspace/service/api-server/cicd
      - tar -zxvf release.tar.gz
      - ls -l
      - /bin/sh deploy_services.sh ${DRONE_TAG} ${DRONE_COMMIT_SHA:0:8}
    when:
      event: tag
    
    +  hipchat: # Notify
    +    image: jmccann/drone-hipchat
    +    url: https://hipchat.your_company_domain.com
    +    room: 19
    +    auth_token: tWVtsTFzsbkwSJO79JHcyb11TR8dLyEYAlicHviB
    +    from: Drone
    +    when:
    +      status: [ success, failure ]
    +    template: &gt;
        &lt;strong&gt;{{ uppercasefirst build.status }}&lt;/strong&gt; &lt;a href=\&quot;{{ system.link_url }}/{{     repo.owner }}/{{ repo.name }}/{{ build.number }}\&quot;&gt;{{ repo.owner }}/{{ repo.name }}#{{     truncate build.commit 8 }}&lt;/a&gt; ({{ build.branch }}) by {{ build.author }} in {{ duration     build.started_at build.finished_at }} &lt;/br&gt; - {{ build.message }}
    
services:  # Dependent service
  mgo:
    image: mongo:latest
    
branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>when è®¾å®šæ¡ä»¶ <code>status: [ success, failure ]</code>ï¼šä¸ç®¡æ„å»ºæˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½ä¼šå‘é€é€šçŸ¥åˆ°æŒ‡å®šçš„ Rooms</li>
<li>template é…ç½®å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="http://ashphy.hateblo.jp/entry/drone-hipchat-plugin">http://ashphy.hateblo.jp/entry/drone-hipchat-plugin</a></li>
</ul>
</blockquote></li>

<li><p>Now, æäº¤ä»£ç è¿›è¡Œæµ‹è¯•(å¤‡æ³¨ï¼šDrone CI/CD è®¾å®šåªåœ¨ master å’Œ ä»¥ release/ å¼€å¤´çš„åˆ†æ”¯èµ·ä½œç”¨)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; notify stage&quot; &amp;&amp; git push
</code></pre></li>

<li><p>æ„å»ºç»“æœå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541125010/blog/images/drone-goweb-app-pipeline-notify-stage.png" alt="" /></p></li>
</ul>

<p>è‡³æ­¤ï¼Œä¸€å¥—å®Œæ•´çš„ Drone CI/CD Pipeline æµå·²é…ç½®å®Œæˆã€‚</p>

<p>æœ€ç»ˆå®Œæ•´çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">goweb-app/
|-- README.md
|-- api
|   |-- app.go
|   `-- model.go
|-- cicd
|   |-- Caddyfile
|   |-- Dockerfile
|   |-- build_app.sh
|   |-- deploy_services.sh
|   |-- docker-compose.yml
|   `-- test_api.sh
|-- go.mod
|-- go.sum
|-- main.go
|-- main_test.go
`-- www
    `-- index.html

3 directories, 14 files
</code></pre>

<h1 id="see-also">See Also</h1>

<blockquote>
<p>Thanks to the authors ğŸ™‚</p>
</blockquote>

<ul>
<li><a href="https://medium.com/@sergey.kolodyazhnyy/continuous-delivery-with-drone-ci-3a3fea5aa83">Medium: Continuous Delivery with Drone CI</a></li>
<li><a href="https://medium.com/@stu60610/%E4%BD%BF%E7%94%A8-docker-drone-%E5%BB%BA%E7%AB%8B%E7%B0%A1%E6%98%93%E8%87%AA%E5%8B%95%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B-part2-7d250e926bd8">Medium: ä½¿ç”¨ Docker &amp; Drone å»ºç«‹ç°¡æ˜“è‡ªå‹•éƒ¨ç½²æµç¨‹â€Šâ€”â€ŠPart2</a></li>
<li><a href="https://golangcaff.com/topics/111/drone-deployment-of-the-go-language-project-with-kubernetes">Drone æ­é… Kubernetes éƒ¨ç½² Go èªè¨€é …ç›®</a></li>
<li><a href="https://github.com/go-training/drone-golang-example">Example: go-training/drone-golang-example</a></li>
<li><a href="https://blog.csdn.net/kikajack/article/details/80585377">Drone æŒç»­é›†æˆå®è·µ - åŸºäº Gogsï¼Œä»¥ Golang ä¸ºä¾‹</a></li>
<li><a href="https://www.jianshu.com/p/1e5f819f8881">æ‰©å±•é˜…è¯»: ç§é’¥ç™»å½•åŸç† + æ·»åŠ secrets + å®‰è£…drone cli</a>
<br /></li>
</ul>

<h1 id="faq">FAQ</h1>

<p>Q: go: golang.org/x/crypto@v0.0.0-20180904163835-0709b304e793: unrecognized import path &ldquo;golang.org/x/crypto&rdquo; (https fetch: Get <a href="https://golang.org/x/crypto?go-get=1:">https://golang.org/x/crypto?go-get=1:</a> dial tcp 216.239.37.1:443: i/o timeout)
   go: golang.org/x/sys@v0.0.0-20180905080454-ebe1bf3edb33: unrecognized import path &ldquo;golang.org/x/sys&rdquo; (https fetch: Get <a href="https://golang.org/x/sys?go-get=1:">https://golang.org/x/sys?go-get=1:</a> dial tcp 216.239.37.1:443: i/o timeout)
   go: error loading module requirements</p>

<p>A: <a href="https://gocn.vip/question/567">https://gocn.vip/question/567</a></p>
    </div>

    
    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">zher</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2018-11-02</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/devops/">devops</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/tech/cloud/docker/registry-and-webui/">
            <span class="next-text nav-default">Docker | Deploy Docker Registry and Web UI</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  

  <div id="gitalk-container"></div>
  <link rel="stylesheet" href="/lib/gitalk/gitalk-1.2.2.min.css">
    <script src="/lib/gitalk/gitalk-1.2.2.min.js"></script>
  <script type="text/javascript">
  var gitalk = new Gitalk({
    id: '2018-10-29 16:58:16 \x2b0800 CST',
    title: 'DevOps | åŸºäº Drone CI éƒ¨ç½² Go è¯­è¨€é¡¹ç›® â€” Web Server',
    clientID: '4357c1dbcf7ef0515c29',
    clientSecret: '1ad00adfd9544bff956529daf898d4b81fed2a9d',
    repo: 'blog-comments',
    owner: 'zhezh09',
    admin: ['zhezh09'],
    body: decodeURI(location.href)
  });
  gitalk.render('gitalk-container');
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:zhezh.boy@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://www.facebook.com/zhe.zh.54" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://plus.google.com/u/0/103084907763171979239" class="iconfont icon-google" title="google"></a>
      <a href="https://github.com/zhezh09" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/p/1005053510554731/home?from=page_100505&amp;mod=TAB&amp;is_all=1#place" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/boy-zhe/activities" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.instagram.com/zher09/" class="iconfont icon-instagram" title="instagram"></a>
  <a href="https://zhezh09.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
    <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">zher</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-123995495-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>



There are two possible situations that led to this error:
  1. You haven&#39;t copied the config.toml yet. See https://github.com/olOwOlo/hugo-theme-even#installation 
  2. You have an incompatible update. See https://github.com/olOwOlo/hugo-theme-even/blob/master/CHANGELOG.md#400-2018-11-06 

有两种可能的情况会导致这个错误发生:
  1. 你还没有复制 config.toml 参考 https://github.com/olOwOlo/hugo-theme-even/blob/master/README-zh.md#installation 
  2. 你进行了一次不兼容的更新 参考 https://github.com/olOwOlo/hugo-theme-even/blob/master/CHANGELOG.md#400-2018-11-06 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>DevOps | 基于 Drone CI 部署 Go 语言项目 — Web Server - Zher</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="zher" /><meta name="description" content="Devops | CI/CD 实践" /><meta name="keywords" content="devops, docker, cicd" />






<meta name="generator" content="Hugo 0.46 with even 4.0.0" />


<link rel="canonical" href="https://zhezh09.github.io/post/tech/cloud/devops/20181029-cicd-03-drone-03-practices2/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script src="https://cdn.jsdelivr.net/npm/eruda@1.2.6/eruda.min.js" integrity="sha256-Jmz4bc3kp+rRrXX2tGadNBKFLwtzMapr8kHABxSAAP8=" crossorigin="anonymous"></script>
<script>eruda.init();</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.93844dae.min.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="DevOps | 基于 Drone CI 部署 Go 语言项目 — Web Server" />
<meta property="og:description" content="Devops | CI/CD 实践" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhezh09.github.io/post/tech/cloud/devops/20181029-cicd-03-drone-03-practices2/" />



<meta property="article:published_time" content="2018-10-29T16:58:16&#43;08:00"/>

<meta property="article:modified_time" content="2018-11-02T16:58:16&#43;00:00"/>











<meta itemprop="name" content="DevOps | 基于 Drone CI 部署 Go 语言项目 — Web Server">
<meta itemprop="description" content="Devops | CI/CD 实践">


<meta itemprop="datePublished" content="2018-10-29T16:58:16&#43;08:00" />
<meta itemprop="dateModified" content="2018-10-29T16:58:16&#43;08:00" />
<meta itemprop="wordCount" content="5369">



<meta itemprop="keywords" content="devops," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="DevOps | 基于 Drone CI 部署 Go 语言项目 — Web Server"/>
<meta name="twitter:description" content="Devops | CI/CD 实践"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Zher</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/categories/footprint/">
        <li class="mobile-menu-item">FootPrint</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Zher</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/footprint/">FootPrint</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">DevOps | 基于 Drone CI 部署 Go 语言项目 — Web Server</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-10-29 </span>
        <div class="post-category">
            <a href="/categories/tech/"> tech </a>
            </div>
          <span class="more-meta"> 5369 words </span>
          <span class="more-meta"> 11 mins read </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#简介">简介</a></li>
<li><a href="#准备-go-web-app-演示项目">准备 Go-Web-App 演示项目</a></li>
<li><a href="#配置-drone-ci-cd-服务">配置 Drone CI/CD 服务</a>
<ul>
<li><a href="#drone-pipeline-单元测试-test">Drone Pipeline: 单元测试(test)</a></li>
<li><a href="#drone-pipeline-构建-go-web-app-build">Drone Pipeline: 构建 Go-Web-App(build)</a></li>
<li><a href="#drone-pipeline-发布-docker-镜像-image">Drone Pipeline: 发布 Docker 镜像(image)</a></li>
<li><a href="#drone-pipeline-上传静态资源和部署脚本-scp">Drone Pipeline: 上传静态资源和部署脚本(scp)</a>
<ul>
<li><a href="#配置-docker-compose-yml">配置 docker-compose.yml</a></li>
</ul></li>
<li><a href="#drone-pipeline-服务部署-deploy">Drone Pipeline: 服务部署(deploy)</a></li>
<li><a href="#drone-pipeline-结果通知-notify-hipchat">Drone Pipeline: 结果通知(notify:hipchat)</a></li>
</ul></li>
<li><a href="#see-also">See Also</a></li>
<li><a href="#faq">FAQ</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <!-- 摘要 -->

<blockquote>
<p>前面完成了基础设施搭建和测试，接下来就该将 Drone CI/CD 应用到项目中了。 这里涉及到的前几篇内容有：</p>

<ul>
<li><a href="https://zhezh09.github.io/post/tech/cloud/devops/20180925-drone-01-basic/">Drone 的基本概念</a></li>
<li><a href="https://zhezh09.github.io/post/tech/cloud/devops/20180926-cicd-03-practices/">Drone 服务部署</a></li>
<li><a href="https://zhezh09.github.io/post/tech/cloud/docker/docker-compose-note/">Docker-Compose 基础</a></li>
<li><a href="https://zhezh09.github.io/post/tech/cloud/docker/registry-and-webui/">Docker Registry 服务部署</a></li>
</ul>
</blockquote>

<p></p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1540883528/20181030-drone-cicd-pipeline-graph.png" alt="" /></p>

<h1 id="简介">简介</h1>

<p>这里以一个 Golang 项目(Go-Web-App)为例，基于 Drone CI 服务完成其自动化部署工作流的配置和演示：主要步骤包含：</p>

<blockquote>
<p>clone =&gt; test =&gt; build =&gt; image =&gt; deploy =&gt; notify</p>
</blockquote>

<p>包含开发的完成流程说明：</p>

<ul>
<li>开发项目代码, 包括源码文件，<code>.drone.yml</code> 文件、Dockerfile 文件等配置文件和一系列执行脚本(*.sh)</li>
<li>提交代码：<code>push</code>、<code>pull request</code>、<code>tag</code> 到代码仓库(Bitbucket Server), 通过 Webhook 触发 Drone 的 Pipeline</li>
<li>Drone 开始 Pipeline 的执行

<ul>
<li>Clone 代码至容器(Drone 默认执行)</li>
<li>执行单元测试</li>
<li>编译代码，构建生成可执行程序</li>
<li>构建 Docker 镜像，并发布到 Docker Registry</li>
<li>打包资源文件、执行脚本、配置文件等到远程测试服务器</li>
<li>部署应用容器到测试环境</li>
<li>结果通知</li>
</ul></li>
</ul>

<blockquote>
<p>Note: Drone 引入了 pipeline 的概念，上述整个构建过程由多个 stage 组成，每一个 stage 都是在一个 Docker 容器内执行:</p>

<ul>
<li>各 stage 间可以通过共享宿主机的磁盘目录, 实现 build 阶段的数据共享和缓存基础数据, 实现加速下次 build 的目标</li>
<li>各 stage 也可以共享宿主机的 docker 环境，实现共享宿主机的 docker image, 不用每次 build 都重新拉取 base image，减少 build 时间</li>
<li>可以并发运行。多个 build 可以并发运行，单机并发数量由服务器 cpu 数决定</li>
</ul>
</blockquote>

<h1 id="准备-go-web-app-演示项目">准备 Go-Web-App 演示项目</h1>

<p>Go-Web-App Demo Project 简介：</p>

<ul>
<li>由 Golang 实现一组 RESTFul API</li>
<li>由 Gorilla Mux 提供路由</li>
<li>由 MongoDB 提供数据存储服务</li>
</ul>

<p>准备 Go-Web-App 项目：</p>

<ul>
<li><p>创建源码根目录</p>

<pre><code class="language-bash">$ cd /home/workspace/code/bitbucket/
$ mkdir goweb-app &amp;&amp; cd goweb-app
</code></pre></li>

<li><p>初始化工程</p>

<pre><code class="language-bash">$ git init
$ touch .gitignore README.md
$ echo .idea &gt;&gt; .gitignore
$ git add --all
$ git commit -m &quot;Initial Commit&quot;
$ git remote add origin http://admin@&lt;_bitbucket_server_&gt;.com:7990/scm/sof/goweb-app.git
$ git push -u origin master
</code></pre></li>

<li><p>添加源码文件</p>

<pre><code class="language-bash">$ mkdir api cicd www 
#   - cicd：存放 Drone CI 服务的相关配置文件和脚本
#   - www： 存放网站资源
$ touch api/app.go api/model.go main.go main_test.go
</code></pre>

<ul>
<li>源码内容可以 <a href="https://github.com/zhezh09/go-practice/tree/master/go-web/restapi">Click Here</a> 进行拷贝。</li>
</ul></li>

<li><p>初始化 go module 并运行项目</p>

<pre><code class="language-bash">$ go mod init go-web
$ go run .
go: finding github.com/gedex/inflector latest
go: finding gopkg.in/mgo.v2 latest
2018/10/31 16:03:14 mgo listen and serve on [mgo, localhost:27017]
2018/10/31 16:03:14 api listen and serve on [:8090]
</code></pre></li>

<li><p>项目创建完成后先提交代码到源码库</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;initial project&quot; &amp;&amp; git push
</code></pre></li>
</ul>

<p>此时的项目结构为：</p>

<pre><code class="language-bash">goweb-app/
|-- README.md
|-- api
|   |-- app.go
|   `-- model.go
|-- go.mod
|-- go.sum
|-- main.go
`-- main_test.go

1 directory, 7 files
</code></pre>

<h1 id="配置-drone-ci-cd-服务">配置 Drone CI/CD 服务</h1>

<p>需要提前阅读的相关文档：</p>

<ul>
<li><a href="http://docs.drone.io/getting-started/">http://docs.drone.io/getting-started/</a></li>
<li><a href="https://zhezh09.github.io/post/tech/cloud/devops/20180925-drone-01-basic/">Drone 的基本概念</a></li>
</ul>

<p>在项目 <code>根目录</code> 创建 Drone CI/CD 的配置文件：<code>.drone.yml</code>；然后跳转到 Drone Web UI：<a href="http://your_company_domain.com:8000">http://your_company_domain.com:8000</a>，完成登陆后 Drone Server 会自动同步你的账号下面的项目列表(或者手动同步)。然后选择需要启用 Drone CI 的项目，点击右侧开关选项即可启用。如下图：</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1540976956/blog/images/drone-enable-repo.png" alt="Drone UI: Repositories" /></p>

<p>最后，需要在 Drone Web UI 管理界面，找到 goweb-app 的设置选项，开启 Repo Hooks，如下图：</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1540977802/blog/images/drone-goweb-app-settings.png" alt="" /></p>

<h2 id="drone-pipeline-单元测试-test">Drone Pipeline: 单元测试(test)</h2>

<p>Go-Web-App 的接口单元测试依赖于 MongoDB 数据库服务，因此在配置 <code>pipeline: test</code> 前需要先配置好 <code>services</code></p>

<ul>
<li><p>需要提前阅读的相关文档：</p>

<ul>
<li><a href="http://docs.drone.io/workspace/">Drone Docs: workspace 介绍</a></li>
<li><a href="http://docs.drone.io/services/">Drone Docs: services 介绍</a></li>
<li><a href="http://docs.drone.io/pipelines/">Drone Docs: pipelines 介绍</a></li>
<li><a href="http://docs.drone.io/mongodb-example/">Drone Docs: services mongodb 使用实例</a></li>
<li><a href="http://docs.drone.io/pipeline-conditions/">Drone Docs: 如何对 pipeline 做条件限制</a></li>
<li><a href="http://docs.drone.io/substitution/">Drone Docs: 使用预设的变量动态配置 pipelines</a></li>
</ul></li>

<li><p>此时 <code>.drone.yml</code> 配置如下：</p>

<pre><code class="language-yml">workspace:
base: /go
path: src/repo/goweb-app

clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true

pipeline:

  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;

  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG

services:  # Dependent service
  mgo:
    image: mongo:latest

branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>workspace 定义了所有工作流步骤共享的容器空间和目录</li>
<li>clone 部分是默认配置, 也可以自定义</li>
<li>Pipeline：<code>ping</code> stage 放在第一步是用来验证 mgo services 已经可以正常提供服务了</li>
<li>命令 <code>mongo --host mgo --eval &quot;{ping:1}</code> 的选项 <code>--host</code> 的值填写 <code>services</code> 部分配置的名称，即：<code>mgo</code></li>
<li>官网的 <code>--eval &quot;{ ping: 1 }&quot;</code> 会导致错误，需改成 <code>--eval &quot;{ping:1}&quot;</code></li>
<li><code>${DRONE_COMMIT_BRANCH}</code> 等一系列预设变量可用来动态配置 pipelines</li>
<li>commands 部分如果内容过多或想让 <code>.drone.yml</code> 配置变得简洁时，可用脚本实现</li>
<li>services 部分用来定义服务应用容器，例如：database、cache、redis等</li>
<li>branches 部分可以用来限定 Drone CI 作用在那些分支上(这里只作用在：master 和 release/* 开头的所有分支上)</li>
</ul>
</blockquote></li>

<li><p>添加脚本 <code>test_api.sh</code>：</p>

<pre><code class="language-bash"># 进入项目根目录，创建 cicd 目录用来存放 Drone 执行时的一些脚本和配置文件
$ cd goweb-app &amp;&amp; mkdir cicd

# 创建 test_api.sh
$ touch test_api.sh 

# 脚本内容如下：

#!/bin/sh
#
# Program: API 单元测试脚本
# Authors: zhangzhe
# History:
#   2018-10-24：编写脚本实现
#

# Pre Set
set -x

# Set ENV
export GO111MODULE=on                               # Go1.11.x 版本需要开启
export http_proxy=http://10.0.0.121:1080
export https_proxy=${http_proxy}

# Set Var
Src=../                                             # 程序源码
DB=$1                                               # Database Server Address
if [ -z $1 ]; then
    DB=mgo:27017
fi

# Golang Test
echo Test Info: $@                                  # 打印构建信息, 脚本执行参数
                                                    # ${DRONE_COMMIT_BRANCH}
                                                    # ${DRONE_COMMIT_SHA:0:8}
                                                    # ${DRONE_BUILD_EVENT}
                                                    # ${DRONE_COMMIT_MESSAGE}
                                                    # ${DRONE_TAG}
echo $PWD

go mod tidy                                         # 解决依赖包
go test -v --cover ${Src} --db_addr=${DB}           # 'mgo:27017' Drone 提供的数据库服务
                                                    # 'localhost:27017' 宿主机提供的数据库服务
</code></pre></li>

<li><p>Now, 提交代码进行测试(备注：Drone CI/CD 设定只在 master 和 以 release/ 开头的分支起作用)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; test stage&quot; &amp;&amp; git push
</code></pre></li>

<li><p>构建结果如下图：</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1540979214/blog/images/drone-goweb-app-pipeline-test-stage.png" alt="" /></p></li>
</ul>

<h2 id="drone-pipeline-构建-go-web-app-build">Drone Pipeline: 构建 Go-Web-App(build)</h2>

<p>单元测试执行完成后，就可以进入 <code>build</code> 阶段来构建可执行程序了。</p>

<ul>
<li><p>此时的 <code>.drone.yml</code> 配置如下：</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/repo/goweb-app
    
clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true
    
pipeline:
  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;
      
  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG
    
    + build:  # Build go app and package source files
    +   image: golang:latest
    +   commands:
    +     - cd cicd
    +     - /bin/sh build_app.sh
    
services:  # Dependent service
  mgo:
    image: mongo:latest
    
branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre></li>

<li><p>构建可执行程序的具体步骤由脚本：build_app.sh 定义，内容如下：</p>

<pre><code class="language-bash"># 进入项目根目录，创建 cicd 目录用来存放 Drone 执行时的一些脚本和配置文件
$ cd cicd

# 创建 build_app.sh
$ touch build_app.sh 

# 脚本内容如下：

#!/bin/sh
#
# Program: 构建 Go-App &amp; 打包资源文件
# Authors: zhangzhe
# History:
#   2018-10-24：编写脚本实现
#

# Pre Set
set -x

# Set ENV
export GO111MODULE=on                               # Go1.11.x 版本需要开启
export http_proxy=http://10.0.0.121:1080
export https_proxy=${http_proxy}

# Set Var
Src=../                                             # 程序源码
Out=&quot;app&quot;
Options=&quot;-a -installsuffix cgo -o&quot;
# PreSet='GOOS=linux GOARCH=amd64'                  # 构建变量设置

# Build
go version
go env

CGO_ENABLED=0 go build -o ${Out} ${Src}             # build

# Package
tar -zcvf release.tar.gz ../www ./*
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>build_app.sh 脚本的最后一行用来打包资源文件(网站资源、配置文件和脚本等)，该资源文件最终需要上传到远程服务器</li>
</ul>
</blockquote></li>

<li><p>最后，在创建 <code>www</code> 目录用来测试静态页面：</p>

<pre><code class="language-bash"># 进入项目根目录，创建 www 目录
$ cd goweb-app &amp;&amp; mkdir www

# 创建 index.html 静态页面
$ touch www/index.html

# 填入如下内容：
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;

&lt;h1&gt;I'm zher.&lt;/h1&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre></li>

<li><p>Now, 提交代码进行测试(备注：Drone CI/CD 设定只在 master 和 以 release/ 开头的分支起作用)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; build stage&quot; &amp;&amp; git push
</code></pre></li>

<li><p>构建结果如下图：</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541037152/blog/images/drone-goweb-app-pipeline-build-stage.png" alt="" /></p></li>
</ul>

<h2 id="drone-pipeline-发布-docker-镜像-image">Drone Pipeline: 发布 Docker 镜像(image)</h2>

<p>这里 Docker 镜像是发布到自建的 Docker Registry Server 的，其部署文档参考：<a href="https://zhezh09.github.io/post/tech/cloud/docker/registry-and-webui/">Docker | Deploy Docker Registry and Web UI</a></p>

<ul>
<li><p>生成 Go-Web-App 的可执行文件后，就可以将其打包为 Docker Image 发布了，此时的 <code>.drone.yml</code> 配置如下：</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/repo/goweb-app

clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true

pipeline:

  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;

  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG

  build:  # Build go app and package source files
    image: golang:latest
    commands:
      - cd cicd
      - /bin/sh build_app.sh

    +  image:  # Build image and publish to private registry
    +    image: plugins/docker
    +    repo: repo.company.com:5000/go-app
    +    registry: repo.company.com:5000
    +    secrets: [ docker_username, docker_password ]
    +    context: ./cicd/
    +    dockerfile: ./cicd/Dockerfile
    +    default_tags: true
    +    when:
    +      event: tag

services:  # Dependent service
  mgo:
    image: mongo:latest

branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li><p>image 阶段使用了插件：<a href="http://plugins.drone.io/drone-plugins/drone-docker/">plugins/docker</a> 来构建 Docker Image 且将其发布到指定的远程 Docker Registry, 详细说明可以查阅其文档</p></li>

<li><p>image 阶段限制只在 <code>tag</code> 事件被触发式才执行 Docker Image 构建和发布</p></li>

<li><p>secrets 选项中的 <code>docker_username &amp; docker_password</code> 是 Drone 注入的，我们需要在提前在 Drone Web 端先设置好这些 secrets，如下图：</p></li>
</ul>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541038364/blog/images/drone-goweb-app-secrets-0.png" alt="" /></p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541037862/blog/images/drone-goweb-app-secrets-1.png" alt="" /></p>
</blockquote></li>

<li><p>构建镜像的 Dockerfile 内容如下：</p>

<pre><code class="language-bash"># 进入项目根目录，创建 cicd 目录用来存放 Drone 执行时的一些脚本和配置文件
$ cd cicd

# 创建 Dockerfile
$ touch Dockerfile

# 填入以下内容：
</code></pre>

<pre><code class="language-Dockerfile"># Program: Dockerfile for API Service
# Build:
#   docker build -t &lt;image_name&gt; .

# 基础镜像
# Usage: FROM image:tag
FROM repo.company.com:5000/alpine:3.8
    
# 设置环境变量
# Usage: ENV &lt;key=value&gt; &lt;key=value&gt;
ENV WorkDir=/home/api

# 指定维护者信息
# Usage: MAINTAINER name
MAINTAINER &lt;xxx@xxx.com&gt;

# 给镜像添加工作目录
# Usage: RUN [命令]
# RUN mkdir -p ${WorkDir}}
# Set Time Zone
RUN echo 'http://mirrors.ustc.edu.cn/alpine/v3.5/main' &gt; /etc/apk/repositories \
    &amp;&amp; echo 'http://mirrors.ustc.edu.cn/alpine/v3.5/community' &gt;&gt; /etc/apk/repositories \
    &amp;&amp; apk update &amp;&amp; apk add tzdata \
    &amp;&amp; ln -sf /usr/share/zoneinfo/Asia/Shanghai/etc/localtime \
    &amp;&amp; echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone

# 设定默认工作路径
# Usage: WORKDIR [path]
WORKDIR ${WorkDir}

# 复制本地应用程序文件[src]到Container的工作目录[dst]
# Usage: COPY [src] [dst]
COPY app ${WorkDir}/

RUN chmod +x ${WorkDir}/app
        
# 容器暴漏给外侧的端口号
# Usage: EXPOSE port [port...]
EXPOSE 80

# 指定容器启动时执行的命令
# Usage: CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]
CMD [&quot;./app&quot;]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>Dockerfile 中的基础镜像使用的是 alpine, 这里将 alpine:3.8 上传到我们自建的 Docker Registry 以节省构建时间。如果使用 Docker Hub 中的镜像每次都要拉取一次，会很慢。</li>
</ul>
</blockquote></li>

<li><p>上传构建 Go-Web-App 的基础镜像到我们自建的 Docker Private Registry:</p>

<ul>
<li><p><a href="https://zhezh09.github.io/post/tech/cloud/docker/registry-and-webui/#测试">上传镜像到 Docker Registry 参考文章</a></p>

<pre><code class="language-bash">$ docker pull alpine:3.8
$ docker tag alpine:3.8 repo.company.com:5000/alpine:3.8
$ docker push repo.company.com:5000/alpine:3.8

# push 失败时，尝试重新登陆后继续 push 即可
</code></pre>

<p>Push <code>repo.company.com:5000/alpine:3.8</code> 成功后，可以打开 Docker Registry UI (<a href="http://your_domain.com:5001">http://your_domain.com:5001</a>) 即可看到刚刚提交的镜像信息。</p></li>
</ul></li>

<li><p>Now, 提交代码进行测试(备注：Drone CI/CD 设定只在 master 和 以 release/ 开头的分支起作用)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; publish image stage&quot; &amp;&amp; git push

# 打 tag, 触发 when: [event: tag] 事件，即触发 publish_image 阶段执行
$ git tag 0.0.1 -m &quot;release 0.0.1&quot; &amp;&amp; git push origin 0.0.1
</code></pre></li>

<li><p>构建结果如下图：</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541079815/blog/images/drone-goweb-app-pipeline-publish-image-stage.png" alt="" /></p>

<ul>
<li>执行完成后可以打开 Docker Registry UI：<a href="http://your.domain.com:5001">http://your.domain.com:5001</a> 看到刚刚构建好的镜像</li>
</ul>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541080216/blog/images/docker-registry-ui-1.png" alt="" /></p></li>
</ul>

<h2 id="drone-pipeline-上传静态资源和部署脚本-scp">Drone Pipeline: 上传静态资源和部署脚本(scp)</h2>

<p>要实现自动部署容器服务，光有镜像是不够的，因此，还需要将网站资源，配置文件等一些脚本打包发到远端服务器上.</p>

<ul>
<li><p>此时的 <code>.drone.yml</code> 配置如下：</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/repo/goweb-app

clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true

pipeline:

  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;

  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG

  build:  # Build go app and package source files
    image: golang:latest
    commands:
      - cd cicd
      - /bin/sh build_app.sh

  image:  # Build image and publish to private registry
    image: plugins/docker
    repo: repo.company.com:5000/go-app
    registry: repo.company.com:5000
    secrets: [ docker_username, docker_password ]
    context: ./cicd/
    dockerfile: ./cicd/Dockerfile
    default_tags: true
    when:
      event: tag

    +  scp:    # Upload resource and config files to remote server
    +    image: appleboy/drone-scp
    +    group: build
    +    host:
    +      - your_server_address
    +    username: root
    +    port: 22
    +    secrets: [ ssh_password ]
    +    target: /home/workspace/service/api-server # 远程服务器目录
    +    source: ./cicd/release.tar.gz              # 打包好的文件
    +    when:
    +      event: tag

services:  # Dependent service
  mgo:
    image: mongo:latest

branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>预设变量 <code>ssh_password</code> 也需要提前在 Drone Web 端设置好</li>
</ul>
</blockquote></li>

<li><p>部署脚本 <code>deploy_services.sh</code> 内容如下：</p>

<pre><code class="language-bash"># 进入项目根目录，创建 cicd 目录用来存放 Drone 执行时的一些脚本和配置文件
$ cd cicd

# 创建部署脚本：deploy_services.sh
$ touch deploy_services.sh

# 填入如下内容：

#!/bin/sh
#
# Program: 部署 Docker 容器服务
# Authors: zhangzhe
# History:
#   2018-10-24：编写脚本实现
#

# Pre Set
set -x

# Set Var
Tag=$1                                    # 读取 git tag (版本号：x.y.z)
Commit=$2                                 # 读取 git commit 号(8位)

if [ -z ${Tag} ]; then
    echo -e &quot;Empty git tag given&quot;
    exit 1
fi

ImageName=go-app:${Tag}                   # 镜像名
Registry=develop.robot-qixing.com:5000    # 私有仓库地址
BaseImage=${Registry}/${ImageName}        # 远程 Image 地址：docker pull ${BaseImage}
ContainerName=api${Tag}

# Reconfigure docker-compose.yml &amp; Caddyfile
sed -i &quot;s/api(@tag)/${ContainerName}/g&quot; docker-compose.yml  # 启动对应版本(Tag)的 API 容器
sed -i &quot;s/(@tag)/${Tag}/g&quot; dockere-compose.yml              # 拉去对应版本(Tag)的 API 镜像
sed -i &quot;s/api(@tag)/${ContainerName}/g&quot; Caddyfile           # Caddy 代理到对应版本的 API 容器服务

# Pull image and run docker container
docker pull ${BaseImage}
docker-compose up -d
docker ps
docker-compose logs caddy
docker-compose logs mgo
docker logs api${Tag}
</code></pre></li>
</ul>

<h3 id="配置-docker-compose-yml">配置 docker-compose.yml</h3>

<ul>
<li><p>开始之前需要阅读的相关文档：</p>

<ul>
<li><a href="https://zhezh09.github.io/post/tech/cloud/docker/docker-compose-note/">Docker-Compose 基础</a></li>
<li><a href="https://hub.docker.com/r/abiosoft/caddy/">https://hub.docker.com/r/abiosoft/caddy/</a></li>
<li><a href="https://hub.docker.com/r/library/mongo/">https://hub.docker.com/r/library/mongo/</a></li>
</ul></li>

<li><p>docker-compose.yml 配置内容如下：</p>

<pre><code class="language-bash">$ cd cicd &amp;&amp; touch docker-compose.yml

# 填入如下内容
</code></pre>

<pre><code class="language-yml">version: '3'
services:
  caddy: # caddy proxy server
    container_name: caddy
    image: abiosoft/caddy:latest
    restart: always
    ports:
      - 80:80
      - 443:443
    volumes:
      - /etc/ssl/server-certs:/root/.caddy
      - ./Caddyfile:/etc/Caddyfile
      - ./www:/srv
    depends_on:
      - api

  api:  # api server
    container_name: api(@tag)
    image: repo.company.com:5000/go-app:(@tag)
    restart: always
    command: './app --port=80 --db_addr=mgo:27017'
    depends_on:
      - mgo

  mgo:  # mgo server
    container_name: mgo
    image: mongo:latest
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: &lt;__input_username__&gt;
      MONGO_INITDB_ROOT_PASSWORD: &lt;__input_password__&gt;
    volumes:
      - ./mgo-data/db:/data/db
</code></pre></li>

<li><p>Caddyfile 配置内容如下：</p>

<pre><code class="language-bash">$ cd cicd &amp;&amp; touch Caddyfile.yml

# 填入如下内容
</code></pre>

<pre><code class="language-Caddyfile">https://company-domain.com {
    gzip
    root /srv
    tls /root/.caddy/cert.crt /root/.caddy/cert.key
    timeouts none

    proxy /v0 api(@tag):80 {
        transparent
        websocket
        except static
    }

    cors /v0 {
        origin            *
        methods           POST,GET,PATCH,DELETE,OPTIONS
        allow_credentials false
        max_age           3600
        allowed_headers   content-type,Authorization
        exposed_headers   X-Something-Special,SomethingElse,Authorization
    }
}
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>docker-compose.yml 和 Caddyfile 文件中的 <code>(@tag)</code> 字段最终会被 ${DRONE_TAG} 替代以生成对应版本的应用容器服务<br /></li>

<li><p>通过 docker-compose 配置 api server、caddy server、mongo server 的参考链接有：</p>

<ul>
<li><a href="https://gist.github.com/wesleybliss/29d4cce863f5964a3eb73c42501d99e4">Mongo: Docker Compose with example App &amp; Mongo</a></li>
<li><a href="https://github.com/tinrab/go-mongo-docker-example/blob/master/docker-compose.yaml">Mongo: go-mongo-docker-example</a></li>
<li><a href="https://gist.github.com/abiosoft/92fa7575d255ef49ec614485e78ed3c5">Caddy: Caddy wordpress docker-compose</a></li>
<li><a href="https://caddy.community/t/docker-compose-localhost-502-error/4184">Caddy: Docker compose localhost 502 error</a></li>
<li><a href="https://caddy.community/t/solved-how-to-configure-caddy-in-docker-container-getting-permission-denied/2076">Caddy: [SOLVED] How to Configure Caddy in Docker Container (Getting Permission Denied)</a></li>
<li><a href="https://github.com/gitlabhq/gitlab-recipes/issues/311">Caddy: Caddy recipe does not work using docker-compose.yml configuration</a></li>
<li><a href="https://gist.github.com/varavut/bb516ca395d85261cb2fe0c8f080c647">Caddy: caddy-part3-docker-compose.yml</a></li>
</ul></li>
</ul>
</blockquote></li>

<li><p>Now, 提交代码进行测试(备注：Drone CI/CD 设定只在 master 和 以 release/ 开头的分支起作用)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; scp stage&quot; &amp;&amp; git push

# 打 tag, 触发 when: [event: tag] 事件，即触发 publish_image 阶段执行
$ git tag 0.0.2 -m &quot;release 0.0.2&quot; &amp;&amp; git push origin 0.0.2
</code></pre></li>

<li><p>构建结果如下图：</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541124663/blog/images/drone-goweb-app-pipeline-scp-stage.png" alt="" /></p></li>
</ul>

<h2 id="drone-pipeline-服务部署-deploy">Drone Pipeline: 服务部署(deploy)</h2>

<p>一切准备好后，就可以执行容器服务部署了，主要包括：Caddy Server Container、Go Web Server Container、MongoDB Server Container，这一组应用容器服务通过 docker-compose 进行管理和组织。</p>

<ul>
<li><p>此时的 <code>.drone.yml</code> 配置如下：</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/repo/goweb-app
    
clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true
    
pipeline:
    
  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;
    
  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG
    
  build:  # Build go app and package source files
    image: golang:latest
    commands:
      - cd cicd
      - /bin/sh build_app.sh
    
  image:  # Build image and publish to private registry
    image: plugins/docker
    repo: repo.company.com:5000/go-app
    registry: repo.company.com:5000
    secrets: [ docker_username, docker_password ]
    context: ./cicd/
    dockerfile: ./cicd/Dockerfile
    default_tags: true
    when:
      event: tag
    
  scp:    # Upload resource and config files to remote server
    image: appleboy/drone-scp
    group: build
    host:
      - your_server_address
    username: root
    port: 22
    secrets: [ ssh_password ]
    target: /home/workspace/service/api-server # 远程服务器目录
    source: ./cicd/release.tar.gz              # 随镜像一起发布的文件
    when:
      event: tag
    
    +  deploy: # Deploy api-server, caddy-server, mgo-server
    +    image: appleboy/drone-ssh
    +    host:
    +      - your_server_address
    +    username: root
    +    port: 22
    +    secrets: [ ssh_password ]
    +    command_timeout: 60
    +    script:
    +      - cd /home/workspace/service/api-server/cicd
    +      - tar -zxvf release.tar.gz
    +      - ls -l
    +      - /bin/sh deploy_services.sh ${DRONE_TAG} ${DRONE_COMMIT_SHA:0:8}
    +    when:
    +      event: tag
    
services:  # Dependent service
  mgo:
    image: mongo:latest
    
branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>Drone Plugins: appleboy/drone-ssh 用来连接到远程服务器</li>
<li>deploy_services.sh 是执行服务部署的脚本，需要接收 ${DRONE_TAG} 用来动态构建容器名称等</li>
</ul>
</blockquote></li>

<li><p>Now, 提交代码进行测试(备注：Drone CI/CD 设定只在 master 和 以 release/ 开头的分支起作用)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; deploy stage&quot; &amp;&amp; git push

# 打 tag, 触发 when: [event: tag] 事件，即触发 publish_image 阶段执行
$ git tag 0.0.3 -m &quot;release 0.0.3&quot; &amp;&amp; git push origin 0.0.3
</code></pre></li>

<li><p>构建结果如下图：</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541125010/blog/images/drone-goweb-app-pipeline-deploy-stage.png" alt="" /></p></li>
</ul>

<h2 id="drone-pipeline-结果通知-notify-hipchat">Drone Pipeline: 结果通知(notify:hipchat)</h2>

<p>为了确保能够及时获取 Drone CI 构建结果，需要选取一种合适的方式来接收通知，这里集成了我们在用的 hipchat.</p>

<ul>
<li><p>此时的 <code>.drone.yml</code> 配置如下：</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/repo/goweb-app
    
clone:    # Clone code from bitbucket
  git:
    image: plugins/git
    depth: 50
    tags: true
    
pipeline:
    
  ping:   # Mgo-server for testing restful api
    image: mongo:latest
    commands:
      - sleep 3
      - mongo --host mgo --eval &quot;{ping:1}&quot;
    
  test:   # Golang unit testing
    image: golang:latest
    group: build
    environment:
      - BRC=${DRONE_COMMIT_BRANCH}
      - SHA=${DRONE_COMMIT_SHA:0:8}
      - EVN=${DRONE_BUILD_EVENT}
      - MSG=${DRONE_COMMIT_MESSAGE}
      - TAG=${DRONE_TAG}
      - MGO=mgo:27017
    commands:
      - cd cicd
      - /bin/sh test_api.sh $MGO $BRC $SHA $EVN $MSG $TAG
    
  build:  # Build go app and package source files
    image: golang:latest
    commands:
      - cd cicd
      - /bin/sh build_app.sh
    when:
      event: tag
    
  image:  # Build image and publish to private registry
    image: plugins/docker
    repo: repo.company.com:5000/go-app
    registry: repo.company.com:5000
    secrets: [ docker_username, docker_password ]
    context: ./cicd/
    dockerfile: ./cicd/Dockerfile
    default_tags: true
    when:
      event: tag
    
  scp:    # Upload resource and config files to remote server
    image: appleboy/drone-scp
    group: build
    host:
      - your_server_address
    username: root
    port: 22
    secrets: [ ssh_password ]
    target: /home/workspace/service/api-server # 远程服务器目录
    source: ./cicd/release.tar.gz              # 随镜像一起发布的文件
    when:
      event: tag
    
  deploy: # Deploy api-server, caddy-server, mgo-server
    image: appleboy/drone-ssh
    host:
      - your_server_address
    username: root
    port: 22
    secrets: [ ssh_password ]
    command_timeout: 60
    script:
      - cd /home/workspace/service/api-server/cicd
      - tar -zxvf release.tar.gz
      - ls -l
      - /bin/sh deploy_services.sh ${DRONE_TAG} ${DRONE_COMMIT_SHA:0:8}
    when:
      event: tag
    
    +  hipchat: # Notify
    +    image: jmccann/drone-hipchat
    +    url: https://hipchat.your_company_domain.com
    +    room: 19
    +    auth_token: tWVtsTFzsbkwSJO79JHcyb11TR8dLyEYAlicHviB
    +    from: Drone
    +    when:
    +      status: [ success, failure ]
    +    template: &gt;
        &lt;strong&gt;{{ uppercasefirst build.status }}&lt;/strong&gt; &lt;a href=\&quot;{{ system.link_url }}/{{     repo.owner }}/{{ repo.name }}/{{ build.number }}\&quot;&gt;{{ repo.owner }}/{{ repo.name }}#{{     truncate build.commit 8 }}&lt;/a&gt; ({{ build.branch }}) by {{ build.author }} in {{ duration     build.started_at build.finished_at }} &lt;/br&gt; - {{ build.message }}
    
services:  # Dependent service
  mgo:
    image: mongo:latest
    
branches:  # Enable Drone CICD on: master &amp; release/* branches
  include: [ master, release/* ]
</code></pre>

<blockquote>
<p>Note:</p>

<ul>
<li>when 设定条件 <code>status: [ success, failure ]</code>：不管构建成功还是失败都会发送通知到指定的 Rooms</li>
<li>template 配置可以参考这篇文章：<a href="http://ashphy.hateblo.jp/entry/drone-hipchat-plugin">http://ashphy.hateblo.jp/entry/drone-hipchat-plugin</a></li>
</ul>
</blockquote></li>

<li><p>Now, 提交代码进行测试(备注：Drone CI/CD 设定只在 master 和 以 release/ 开头的分支起作用)</p>

<pre><code class="language-bash">$ git add -A &amp;&amp; git commit -m &quot;test drone cicd pipeline -&gt; notify stage&quot; &amp;&amp; git push
</code></pre></li>

<li><p>构建结果如下图：</p>

<p><img src="https://res.cloudinary.com/zher-files/image/upload/v1541125010/blog/images/drone-goweb-app-pipeline-notify-stage.png" alt="" /></p></li>
</ul>

<p>至此，一套完整的 Drone CI/CD Pipeline 流已配置完成。</p>

<p>最终完整的项目结构如下：</p>

<pre><code class="language-bash">goweb-app/
|-- README.md
|-- api
|   |-- app.go
|   `-- model.go
|-- cicd
|   |-- Caddyfile
|   |-- Dockerfile
|   |-- build_app.sh
|   |-- deploy_services.sh
|   |-- docker-compose.yml
|   `-- test_api.sh
|-- go.mod
|-- go.sum
|-- main.go
|-- main_test.go
`-- www
    `-- index.html

3 directories, 14 files
</code></pre>

<h1 id="see-also">See Also</h1>

<blockquote>
<p>Thanks to the authors 🙂</p>
</blockquote>

<ul>
<li><a href="https://medium.com/@sergey.kolodyazhnyy/continuous-delivery-with-drone-ci-3a3fea5aa83">Medium: Continuous Delivery with Drone CI</a></li>
<li><a href="https://medium.com/@stu60610/%E4%BD%BF%E7%94%A8-docker-drone-%E5%BB%BA%E7%AB%8B%E7%B0%A1%E6%98%93%E8%87%AA%E5%8B%95%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B-part2-7d250e926bd8">Medium: 使用 Docker &amp; Drone 建立簡易自動部署流程 — Part2</a></li>
<li><a href="https://golangcaff.com/topics/111/drone-deployment-of-the-go-language-project-with-kubernetes">Drone 搭配 Kubernetes 部署 Go 語言項目</a></li>
<li><a href="https://github.com/go-training/drone-golang-example">Example: go-training/drone-golang-example</a></li>
<li><a href="https://blog.csdn.net/kikajack/article/details/80585377">Drone 持续集成实践 - 基于 Gogs，以 Golang 为例</a></li>
<li><a href="https://www.jianshu.com/p/1e5f819f8881">扩展阅读: 私钥登录原理 + 添加secrets + 安装drone cli</a>
<br /></li>
</ul>

<h1 id="faq">FAQ</h1>

<p>Q: go: golang.org/x/crypto@v0.0.0-20180904163835-0709b304e793: unrecognized import path &ldquo;golang.org/x/crypto&rdquo; (https fetch: Get <a href="https://golang.org/x/crypto?go-get=1:">https://golang.org/x/crypto?go-get=1:</a> dial tcp 216.239.37.1:443: i/o timeout)
   go: golang.org/x/sys@v0.0.0-20180905080454-ebe1bf3edb33: unrecognized import path &ldquo;golang.org/x/sys&rdquo; (https fetch: Get <a href="https://golang.org/x/sys?go-get=1:">https://golang.org/x/sys?go-get=1:</a> dial tcp 216.239.37.1:443: i/o timeout)
   go: error loading module requirements</p>

<p>A: <a href="https://gocn.vip/question/567">https://gocn.vip/question/567</a></p>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">zher</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2018-11-02</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/devops/">devops</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/tech/tools/useful_git_scripts/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Tools | Useful Git Scripts</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/tech/cloud/docker/registry-and-webui/">
            <span class="next-text nav-default">Docker | Deploy Docker Registry and Web UI</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2018-10-29 16:58:16 \x2b0800 CST',
        title: 'DevOps | 基于 Drone CI 部署 Go 语言项目 — Web Server',
        clientID: '4357c1dbcf7ef0515c29',
        clientSecret: '1ad00adfd9544bff956529daf898d4b81fed2a9d',
        repo: 'blog-comments',
        owner: 'zhezh09',
        admin: ['zhezh09'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:zhezh.boy@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/zher16297365" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://www.facebook.com/zhe.zh.54" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://plus.google.com/u/0/103084907763171979239" class="iconfont icon-google" title="google"></a>
      <a href="https://github.com/zhezh09" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/p/1005053510554731/home?from=page_100505&amp;mod=TAB&amp;is_all=1#place" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/boy-zhe/activities" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.instagram.com/zher09/" class="iconfont icon-instagram" title="instagram"></a>
  <a href="https://zhezh09.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">zher</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/even.ece58db6.min.js"></script>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-123995495-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>

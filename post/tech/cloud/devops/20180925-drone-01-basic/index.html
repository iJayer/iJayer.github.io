<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>DevOps | Drone çš„åŸºæœ¬æ¦‚å¿µ - Zher&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="zher" />
  <meta name="description" content=" Drone ä¸€ä¸ªåŸç”Ÿæ”¯æŒ Docker çš„å¼€æº CI ç³»ç»Ÿï¼ŒåŸºäº Go ç¼–å†™ã€‚
 Drone çš„æ ¸å¿ƒæ¦‚å¿µ Drone çš„è¿ä½œåŸç†(æ¶æ„) Drone çš„åŸºæœ¬æœ¯è¯­  
" />
<meta name="keywords" content="ci/cd, drone, docker" />







<meta name="generator" content="Hugo 0.46" />


<link rel="canonical" href="https://zhezh09.github.io/post/tech/cloud/devops/20180925-drone-01-basic/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<script src="https://cdn.jsdelivr.net/npm/eruda@1.2.6/eruda.min.js" integrity="sha256-Jmz4bc3kp+rRrXX2tGadNBKFLwtzMapr8kHABxSAAP8=" crossorigin="anonymous"></script>
<script>eruda.init();</script>


<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="DevOps | Drone çš„åŸºæœ¬æ¦‚å¿µ" />
<meta property="og:description" content="


Drone ä¸€ä¸ªåŸç”Ÿæ”¯æŒ Docker çš„å¼€æº CI ç³»ç»Ÿï¼ŒåŸºäº Go ç¼–å†™ã€‚


Drone çš„æ ¸å¿ƒæ¦‚å¿µ
Drone çš„è¿ä½œåŸç†(æ¶æ„)
Drone çš„åŸºæœ¬æœ¯è¯­


" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhezh09.github.io/post/tech/cloud/devops/20180925-drone-01-basic/" />



<meta property="article:published_time" content="2018-09-25T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2018-10-17T00:00:00&#43;00:00"/>











<meta itemprop="name" content="DevOps | Drone çš„åŸºæœ¬æ¦‚å¿µ">
<meta itemprop="description" content="


Drone ä¸€ä¸ªåŸç”Ÿæ”¯æŒ Docker çš„å¼€æº CI ç³»ç»Ÿï¼ŒåŸºäº Go ç¼–å†™ã€‚


Drone çš„æ ¸å¿ƒæ¦‚å¿µ
Drone çš„è¿ä½œåŸç†(æ¶æ„)
Drone çš„åŸºæœ¬æœ¯è¯­


">


<meta itemprop="datePublished" content="2018-09-25T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-09-25T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="4388">



<meta itemprop="keywords" content="devops," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="DevOps | Drone çš„åŸºæœ¬æ¦‚å¿µ"/>
<meta name="twitter:description" content="


Drone ä¸€ä¸ªåŸç”Ÿæ”¯æŒ Docker çš„å¼€æº CI ç³»ç»Ÿï¼ŒåŸºäº Go ç¼–å†™ã€‚


Drone çš„æ ¸å¿ƒæ¦‚å¿µ
Drone çš„è¿ä½œåŸç†(æ¶æ„)
Drone çš„åŸºæœ¬æœ¯è¯­


"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Zher&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/categories/footprint/">
        <li class="mobile-menu-item">FootPrint</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Zher&#39;s Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/footprint/">FootPrint</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">DevOps | Drone çš„åŸºæœ¬æ¦‚å¿µ</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-09-25 </span>
        <div class="post-category">
            
              <a href="/categories/tech/"> tech </a>
            
          </div>
        <span class="more-meta"> 4388 words </span>
        <span class="more-meta"> 9 mins read </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#drone">Drone</a>
<ul>
<li><a href="#å®‰è£…">å®‰è£…</a></li>
</ul></li>
<li><a href="#drone-çš„åŸºæœ¬æ¦‚å¿µ">Drone çš„åŸºæœ¬æ¦‚å¿µ</a></li>
<li><a href="#drone-çš„åŸºæœ¬åŸç†">Drone çš„åŸºæœ¬åŸç†</a></li>
<li><a href="#drone-çš„åŸºæœ¬æœ¯è¯­">Drone çš„åŸºæœ¬æœ¯è¯­</a>
<ul>
<li><a href="#webhooks">Webhooks</a></li>
<li><a href="#è·³è¿‡æäº¤">è·³è¿‡æäº¤</a></li>
<li><a href="#åŒ…å«-è·³è¿‡åˆ†æ”¯-branches">åŒ…å«/è·³è¿‡åˆ†æ”¯ Branches</a></li>
<li><a href="#workspace">Workspace</a>
<ul>
<li><a href="#base-å±æ€§">base å±æ€§</a></li>
<li><a href="#path-å±æ€§">path å±æ€§</a></li>
<li><a href="#cloning">cloning</a></li>
</ul></li>
<li><a href="#pipelines">Pipelines</a>
<ul>
<li><a href="#æ„å»ºæ­¥éª¤">æ„å»ºæ­¥éª¤</a></li>
<li><a href="#å¹¶è¡Œæ‰§è¡Œ-group">å¹¶è¡Œæ‰§è¡Œ group</a></li>
<li><a href="#æ¡ä»¶æ‰§è¡Œ-when">æ¡ä»¶æ‰§è¡Œ when</a></li>
<li><a href="#æ•…éšœæ‰§è¡Œ-when-status">æ•…éšœæ‰§è¡Œ when + status</a></li>
</ul></li>
<li><a href="#services">Services</a>
<ul>
<li><a href="#é…ç½®">é…ç½®</a></li>
<li><a href="#åˆå§‹åŒ–">åˆå§‹åŒ–</a></li>
</ul></li>
<li><a href="#plugins">Plugins</a>
<ul>
<li><a href="#æ’ä»¶éš”ç¦»">æ’ä»¶éš”ç¦»</a></li>
<li><a href="#æ’ä»¶å¸‚åœº">æ’ä»¶å¸‚åœº</a></li>
</ul></li>
<li><a href="#deployments">Deployments</a>
<ul>
<li><a href="#è§¦å‘éƒ¨ç½²">è§¦å‘éƒ¨ç½²</a></li>
</ul></li>
<li><a href="#matrix-builds-çŸ©é˜µæ„å»º">Matrix Builds çŸ©é˜µæ„å»º</a>
<ul>
<li><a href="#å˜é‡æ’å€¼">å˜é‡æ’å€¼</a></li>
</ul></li>
<li><a href="#environment">Environment</a>
<ul>
<li><a href="#drone-yml-é¢„è®¾çš„å˜é‡-å…±æœ‰ä¸¤å¤„">.drone.yml é¢„è®¾çš„å˜é‡ï¼Œå…±æœ‰ä¸¤å¤„ï¼š</a></li>
<li><a href="#ci-å®¹å™¨ç«¯çš„å˜é‡">CI å®¹å™¨ç«¯çš„å˜é‡</a></li>
</ul></li>
</ul></li>
<li><a href="#see-also">See Also</a></li>
</ul>
</nav>
  </div>
</div>

    
    

    
    <div class="post-content">
      <!-- æ‘˜è¦ -->

<blockquote>
<p><code>Drone</code> ä¸€ä¸ªåŸç”Ÿæ”¯æŒ Docker çš„å¼€æº CI ç³»ç»Ÿï¼ŒåŸºäº Go ç¼–å†™ã€‚</p>

<ul>
<li>Drone çš„æ ¸å¿ƒæ¦‚å¿µ</li>
<li>Drone çš„è¿ä½œåŸç†(æ¶æ„)</li>
<li>Drone çš„åŸºæœ¬æœ¯è¯­</li>
</ul>

<p></p>

<ul>
<li><a href="https://developer.finogeeks.com/topic/11/geekpipe-%E5%9F%BA%E4%BA%8Edrone%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E5%AE%9E%E8%B7%B5%E4%B9%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E7%AF%87">è½¬è‡ªï¼šGeekPipe-åŸºäºDroneçš„æŒç»­é›†æˆå®è·µä¹‹åŸºæœ¬æ¦‚å¿µç¯‡</a></li>
</ul>
</blockquote>

<h1 id="drone">Drone</h1>

<ul>
<li><a href="https://drone.io/">Drone å®˜ç½‘</a></li>
<li><a href="http://plugins.drone.io/">Drone æ’ä»¶</a></li>
</ul>

<h2 id="å®‰è£…">å®‰è£…</h2>

<p><a href="http://docs.drone.io/zh/installation/">Install</a></p>

<ul>
<li><p>é€šè¿‡ Docker å®‰è£…</p>

<p><a href="https://hub.docker.com/r/drone/drone/">Drone in Docker Hub</a></p>

<pre><code class="language-bash">$ docker pull drone/drone
# é»˜è®¤å®‰è£…æœ€æ–°ç‰ˆ
</code></pre></li>
</ul>

<h1 id="drone-çš„åŸºæœ¬æ¦‚å¿µ">Drone çš„åŸºæœ¬æ¦‚å¿µ</h1>

<p>Drone æ˜¯ä¸€ä¸ªåŸºäº Docker å®¹å™¨æŠ€æœ¯çš„å¯æ‰©å±•çš„æŒç»­é›†æˆå¼•æ“ï¼Œç”¨äºè‡ªåŠ¨åŒ–æµ‹è¯•ä¸æ„å»ºï¼Œç”šè‡³å‘å¸ƒã€‚æ¯ä¸ªæ„å»ºéƒ½åœ¨ä¸€ä¸ªä¸´æ—¶çš„Dockerå®¹å™¨ä¸­æ‰§è¡Œï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿå®Œå…¨æ§åˆ¶å…¶æ„å»ºç¯å¢ƒå¹¶ä¿è¯éš”ç¦»ã€‚å¼€å‘è€…åªéœ€åœ¨é¡¹ç›®ä¸­åŒ…å« .drone.yml æ–‡ä»¶ï¼Œå°†ä»£ç æ¨é€åˆ° git ä»“åº“ï¼ŒDrone å°±èƒ½å¤Ÿè‡ªåŠ¨åŒ–çš„è¿›è¡Œç¼–è¯‘ã€æµ‹è¯•ã€å‘å¸ƒã€‚</p>

<blockquote>
<p>é˜…è¯»è¦æ±‚</p>

<ul>
<li>ç†Ÿæ‚‰ Docker ä»¥åŠ Docker Compose</li>
<li>ç†Ÿæ‚‰ Git åŸºæœ¬å‘½ä»¤</li>
<li>å¯¹ CI/CD æœ‰ä¸€å®šäº†è§£</li>
</ul>
</blockquote>

<h1 id="drone-çš„åŸºæœ¬åŸç†">Drone çš„åŸºæœ¬åŸç†</h1>

<p>Drone çš„éƒ¨ç½²åˆ†ä¸º <code>Server(Drone-Server)</code> å’Œ <code>Agent(Drone-agent)</code>, Server ç«¯è´Ÿè´£åå°ç®¡ç†ç•Œé¢ä»¥åŠè°ƒåº¦ï¼ŒAgent è´Ÿè´£å…·ä½“çš„ä»»åŠ¡æ‰§è¡Œã€‚æ¯”å¦‚é…ç½®æ–‡ä»¶ <code>.drone.yml</code> é‡Œçš„ parsing å‘ç”Ÿåœ¨ drone-server ç«¯ï¼Œè€Œå…·ä½“çš„æ‰§è¡Œæ­¥éª¤åˆ™åœ¨ drone-agent ç«¯é‡Œæ‰§è¡Œã€‚ä¹Ÿå°±æ„å‘³ç€ environment/build_args å…³é”®å­—æ˜¯ä¸å½±å“é…ç½®æ–‡ä»¶ .drone.yml æœ¬èº«ç¯å¢ƒå˜é‡çš„è§£ææ›¿æ¢ã€‚</p>

<p>Droneçš„éƒ¨ç½²åˆ†ä¸ºServerï¼ˆdrone-serverï¼‰å’ŒAgentï¼ˆdrone-agentï¼‰ï¼š</p>

<ul>
<li>Serverç«¯ï¼šè´Ÿè´£åå°ç®¡ç†ç•Œé¢ä»¥åŠè°ƒåº¦</li>

<li><p>Agentç«¯ï¼šåˆ™è´Ÿè´£å…·ä½“çš„ä»»åŠ¡æ‰§è¡Œ</p>

<p>æ¯”å¦‚é…ç½®æ–‡ä»¶ .drone.yml é‡Œçš„ parsing å‘ç”Ÿåœ¨ drone-serverç«¯ï¼Œè€Œå…·ä½“çš„æ­¥éª¤åˆ™åœ¨ drone-agentç«¯é‡Œæ‰§è¡Œã€‚ä¹Ÿå°±æ„å‘³ç€environment/build_argså…³é”®å­—æ˜¯ä¸å½±å“ é…ç½®æ–‡ä»¶.drone.yml æœ¬èº«ç¯å¢ƒå˜é‡çš„è§£ææ›¿æ¢ã€‚</p></li>
</ul>

<p>ç›®å‰Drone æ”¯æŒå¤šç§ä»£ç æ‰˜ç®¡æœåŠ¡ï¼Œå‡ ä¹æ¶µç›–å¸‚é¢ä¸Šä¸»æµçš„ä»£ç ä»“åº“ï¼Œå¦‚Github, GitLab, Gogs, Giteaã€Bitbucket Serverç­‰ï¼Œä¸”åœ¨drone-server é‡Œé¢„è®¾äº†å¯¹åº”æ‰˜ç®¡æœåŠ¡çš„ APIï¼ŒDrone çš„å¾ˆå¤šåŠŸèƒ½æ¯”å¦‚æ‹‰å– git repo list/add webhook to repo éƒ½æ˜¯é€šè¿‡è¿™äº› API å®Œæˆçš„ã€‚å¦å¤– Droneçš„è´¦æˆ·ä½“ç³»ä¾èµ–äºæ‰˜ç®¡æœåŠ¡çš„è´¦æˆ·ç³»ç»Ÿï¼Œ å¹¶ä¸å­˜åœ¨ç»´æŠ¤è´¦æˆ·è¿™ä¸ªæ¦‚å¿µã€‚ä¾‹å¦‚æˆ‘ä»¬ä½¿ç”¨Gogsä½œä¸ºä»£ç æ‰˜ç®¡æœåŠ¡ï¼Œæˆ‘ä»¬åœ¨ç™»å½• Drone æ—¶ï¼Œå®é™…ä¸Šæ˜¯ Drone æŠŠç”¨æˆ·åå¯†ç ä¼ ç»™äº† Gogs. å› æ­¤ï¼Œæ¿€æ´»æŸä¸ª Repository ï¼ˆä»“åº“ï¼‰ çš„æ„å»º(ä¸ºRepository æ·»åŠ webhook) èƒ½å¦æˆåŠŸå–å†³äºè¯¥è´¦å·åœ¨ Gogs é‡Œæ˜¯ä¸æ˜¯è¯¥ Repository çš„ç®¡ç†å‘˜ã€‚</p>

<h1 id="drone-çš„åŸºæœ¬æœ¯è¯­">Drone çš„åŸºæœ¬æœ¯è¯­</h1>

<h2 id="webhooks">Webhooks</h2>

<p>Drone é€šè¿‡ OAuth è®¤è¯æˆ–è´¦å·å¯†ç ç™»é™†ä»£ç ä»“åº“åï¼Œè·å¾—å®Œæ•´çš„æ§åˆ¶æƒã€‚åœ¨ Drone çš„ web åå°ç®¡ç†é¡µé¢æ¿€æ´» Repo åï¼ŒDrone è°ƒç”¨ä»£ç ä»“åº“çš„ API ç»™ Repository å¢åŠ ä¸€ä¸ª webhook, å½“ Repository å‡ºå‘ç›¸åº”äº‹ä»¶(push, tag, pull request) æ—¶ï¼Œä»£ç ä»“åº“å‘èµ· http è¯·æ±‚å›è°ƒ drone è§¦å‘æ„å»ºã€‚</p>

<p>Webhooks ç”±ä»£ç ä»“åº“å‘é€ï¼Œç”¨äºè§¦å‘ pipeline. ä»£ç ä»“åº“ä¼šåœ¨ä¸‹é¢ 3 ä¸­æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨å‘é€ Webhook è¯·æ±‚åˆ° Drone:</p>

<ul>
<li>ä»£ç è¢« push åˆ° Repo</li>
<li>æ–°å»ºä¸€ä¸ªåˆå¹¶è¯·æ±‚ (pull request)</li>
<li>æ–°å»ºä¸€ä¸ª tag</li>
</ul>

<h2 id="è·³è¿‡æäº¤">è·³è¿‡æäº¤</h2>

<p>åœ¨æœ¬åœ°ç”¨ git æäº¤ä»£ç çš„æ—¶å€™å¯ä»¥é€šè¿‡æ·»åŠ  <code>[CI SKIP]</code>(å¤§å°å†™ä¸æ•æ„Ÿ) åˆ°æäº¤ä¿¡æ¯(commit message) ä¸­æ¥è®© Drone è·³è¿‡æŸä¸ªæäº¤ã€‚</p>

<pre><code class="language-bash">$ git commit -m &quot;updated README [CI SKIP]&quot;
</code></pre>

<h2 id="åŒ…å«-è·³è¿‡åˆ†æ”¯-branches">åŒ…å«/è·³è¿‡åˆ†æ”¯ Branches</h2>

<p>Drone å¯ä»¥é€šè¿‡å‚æ•° <code>branches</code> å¿½ç•¥æŸä¸ªåˆ†æ”¯ä¸Šçš„æäº¤ã€‚branches æ”¯æŒå•ä¸ªå˜é‡ï¼Œæ•°ç»„ï¼Œé€šé…ç¬¦ï¼Œè¿˜æ”¯æŒè‡ªé€‰é¡¹ <code>exclude</code> (ä¸åŒ…å«åˆ†æ”¯)</p>

<ul>
<li><p>è·³è¿‡ä¸æ˜¯ master åˆ†æ”¯çš„æäº¤ï¼š</p>

<pre><code class="language-yml">pipeline:
  build:
    image: golang
    commands:
    - go build 
    - go test

branches: master
</code></pre></li>

<li><p>è·³è¿‡åŒ¹é…å¤–çš„ç›®æ ‡åˆ†æ”¯æäº¤-å¤šä¸ªç›®æ ‡åŒ¹é…ï¼š</p>

<pre><code class="language-yml">pipeline:
  build:
    image: golang
    commands:
      - go build 
      - go test

branches: [master, develop]
</code></pre></li>

<li><p>æäº¤åŒ¹é…åŒ…å«çš„ç›®æ ‡åˆ†æ”¯ï¼š</p>

<pre><code class="language-yml">pipeline:
  build:
    image: golang
    commands:
      - go build
      - go test

branches:
  include: [ master, feature/* ]
</code></pre></li>

<li><p>å¿½ç•¥ç›®æ ‡åˆ†æ”¯çš„æäº¤ï¼š</p>

<pre><code class="language-yml">pipeline:
  build:
    image: golang
    commands:
      - go build
      - go test

branches:
  exclude: [ develop, feature/* ]
</code></pre></li>
</ul>

<h2 id="workspace">Workspace</h2>

<p>Workspace å®šä¹‰äº†æ‰€æœ‰å·¥ä½œæµæ­¥éª¤å…±äº«çš„å®¹å™¨ç©ºé—´å’Œç›®å½•ã€‚å„ä¸ªé˜¶æ®µé€šè¿‡å„ä¸ªé˜¶æ®µå…±äº« volume å’Œå·¥ä½œè·¯å¾„ï¼Œé¿å…äº†å¤åˆ¶ã€‚é»˜è®¤çš„å·¥ä½œåŒºçš„ç›®å½•å’Œä»“åº“çš„ URL ç›¸åŒ¹é…ã€‚</p>

<pre><code>/drone/src/gogs/test/hello-world
</code></pre>

<ul>
<li><p>å¯ä»¥ä½¿ç”¨ YAML æ–‡ä»¶é‡Œçš„ <code>workspace</code> æ¥è‡ªå®šä¹‰å·¥ä½œåŒºï¼š</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/gogs/test/hello-world
    
pipeline:
  build:
    image: golang:latest
    commands:
      - go get
      - go test
</code></pre></li>
</ul>

<h3 id="base-å±æ€§">base å±æ€§</h3>

<p><code>base</code> å±æ€§å®šä¹‰äº†æ‰€æœ‰å·¥ä½œæµæ­¥éª¤å…±äº«çš„åŸºç¡€å®¹å™¨ç©ºé—´ã€‚åŸºç¡€å®¹å™¨ç©ºé—´ä¿è¯äº†ä»£ç ã€ä¾èµ–å’Œç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶èƒ½å¤Ÿåœ¨å„ä¸ªæ­¥éª¤é—´æŒä¹…åŒ–å’Œå…±äº«ã€‚</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/gogs/test/hello-world

pipeline:
  deps:
    image: golang:latest
    commands:
      - go get
      - go test
  build:
    image: node:latest
    commands:
      - go build
</code></pre>

<p>ä¸Šé¢çš„æ­¥éª¤å°†å’Œä¸‹é¢çš„ docker å‘½ä»¤ç±»ä¼¼ï¼š</p>

<pre><code class="language-bash">$ docker volume create my-named-volume
$ docker run --volume=my-named-volume:/go golang:latest
$ docker run --volume=my-named-volume:/go node:latest
</code></pre>

<h3 id="path-å±æ€§">path å±æ€§</h3>

<p>path å±æ€§å®šä¹‰äº†æ„å»ºçš„å·¥ä½œç›®å½•ã€‚è¿™æ˜¯ä»£ç è¢«å…‹éš†åˆ°çš„ç›®å½•ï¼Œä¹Ÿå°†æ˜¯æ¯ä¸€ä¸ªæ„å»ºæ­¥éª¤çš„é»˜è®¤å·¥ä½œç›®å½•ã€‚è¿™ä¸ªè·¯å¾„å¿…é¡»æ˜¯åŸºäº base è·¯å¾„çš„ç›¸å¯¹è·¯å¾„ã€‚</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/gogs/test/hello-world
</code></pre>

<p>ç›¸å½“äºï¼š</p>

<pre><code class="language-bash">$ git clone https://gogs/test/hello-world /go/src/gogs/test/hello-world
</code></pre>

<h3 id="cloning">cloning</h3>

<p>Drone å…è®¸åœ¨å·¥ä½œæµä¸­æ‰‹åŠ¨é…ç½®å…‹éš†æ­¥éª¤ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰å…·ä½“çš„å…‹éš†æ­¥éª¤ï¼ŒDrone ä¼šè‡ªåŠ¨é…ç½®ã€‚</p>

<pre><code class="language-yml">clone:
  git:
    image: pugins/git

pipeline:
  build:
    image:golang
    commands:
      - go build
      - go test 
</code></pre>

<p>depth å¯ç§€å˜å…‹éš†æ·±åº¦ï¼Œå½“ depth ä¸º 1 æ—¶ï¼Œåªå…‹éš†å½“å‰ç‰ˆæœ¬ï¼Œä¸å…‹éš†å½“å‰ç‰ˆæœ¬ä»¥å¤–çš„æäº¤è®°å½•ï¼Œå¦‚æœè¯¥å‚æ•°æœªæŒ‡å®šï¼Œé»˜è®¤æ‰€æœ‰ç‰ˆæœ¬æäº¤éƒ½å…‹éš†ï¼š</p>

<pre><code class="language-yml">clone:
  git:
    image: plugins/git
    depth: 50
</code></pre>

<p>é€šè¿‡ image æŒ‡å®šå…‹éš†æ’ä»¶æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>plugins/</code> ä¸‹çš„é¢„å®šä¹‰æ’ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶ï¼š</p>

<pre><code class="language-yml">clone:
  git:
    image: test/custom-git-plugin
</code></pre>

<h2 id="pipelines">Pipelines</h2>

<p>Drone çš„æ ¸å¿ƒæ¦‚å¿µï¼Œ<code>pipelines</code> å®šä¹‰äº†å·¥ä½œæµ(æˆ–å«æµæ°´çº¿)ï¼ŒåŒ…å«ä»£ç æ„å»ºï¼Œä»£ç æµ‹è¯•å’Œä»£ç éƒ¨ç½²ç­‰ä¸€ç³»åˆ—æ­¥éª¤ã€‚drone-agent ä»¥è‡ªä¸Šè€Œä¸‹çš„é¡ºåºä¾æ¬¡æ‰§è¡Œ pipeline å…³é”®å­—é‡Œå£°æ˜çš„æ­¥éª¤ã€‚å¦‚æœä¸€ä¸ªæ­¥éª¤è¿”å›äº†é 0 çš„é€€å‡ºä»£ç ï¼Œå·¥ä½œæµå°†ç«‹å³åœæ­¢å¹¶è¿”å›ä¸€ä¸ªé”™è¯¯çŠ¶æ€ã€‚</p>

<p>ä¾‹å¦‚ï¼Œå®šä¹‰äº†ä¸¤ä¸ªå·¥ä½œæµï¼Œåå­—ä¸º frontend å’Œ backend:</p>

<pre><code class="language-yml">pipeline:
  backend:
    image: golang
    commands:
      - go build 
      - go test
  frontent:
    image: node
    commands:
      - npm install
      - npm run test
      - npm run build
</code></pre>

<h3 id="æ„å»ºæ­¥éª¤">æ„å»ºæ­¥éª¤</h3>

<p>æ„å»ºæ­¥éª¤æ˜¯å·¥ä½œæµåœ¨ Docker å®¹å™¨ä¸­æ‰§è¡Œçš„å‘½ä»¤ã€‚è¿™äº›å‘½ä»¤å°†å·¥ä½œåŒº(Workspace) ä½œä¸ºå·¥ä½œè·¯å¾„ã€‚</p>

<pre><code class="language-yml">pipeline:
  backend:
    image: golang
    commands:
+     - go build 
+     - go test
</code></pre>

<p>ä¸Šé¢çš„ commands å°†ä¼šè¢«è½¬æ¢æˆç®€å•çš„ Shell è„šæœ¬ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">#!/bin/sh

set -e 

go build 
go test
</code></pre>

<p>ä¸Šé¢çš„è„šæœ¬åœ¨ä¹‹åä¼šè¢«ä½œä¸º Docker çš„å…¥å£è¢«æ‰§è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<pre><code class="language-bash">$ docker run --entrypoint=build.sh golang
</code></pre>

<blockquote>
<p>Note: åªæœ‰æ„å»ºæ­¥éª¤å¯ä»¥å®šä¹‰å‘½ä»¤(commands), ä¸èƒ½ä½¿ç”¨æ’ä»¶(plugins) æˆ–è€…æœåŠ¡(services) æ¥å®šä¹‰å‘½ä»¤ã€‚</p>
</blockquote>

<h3 id="å¹¶è¡Œæ‰§è¡Œ-group">å¹¶è¡Œæ‰§è¡Œ group</h3>

<p>Drone æ”¯æŒåœ¨åŒä¸€ä¸ªç¤ºä¾‹ä¸Šå¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ­¥éª¤ã€‚ä½¿ç”¨ <code>group</code> å±æ€§æ¥é…ç½®å¹¶è¡Œæ­¥éª¤ï¼Œè¿™å°†è®©å·¥ä½œæµæ‰§è¡Œè€… (pipeline runner) å¹¶è¡Œæ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤ã€‚</p>

<p>å¹¶è¡Œæ‰§è¡Œé…ç½®å®ä¾‹ï¼š</p>

<pre><code class="language-yml">pipeline:
  backend:
    group: build
      image: golang
      commands:
        - go build
        - go test
  frontend:
    group: build
      image: node
      commands:
       - npm install 
       - npm run test
       - npm run build 
  publish:
    image: plugins/docker
    repo: test/hello-world
</code></pre>

<p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œfrontend å’Œ backend å°†å¹¶è¡Œæ‰§è¡Œã€‚åœ¨è¿™ä¸¤ç»„ä»»åŠ¡å®Œæˆä¹‹å‰ï¼Œpublish æ­¥éª¤å°†ä¸ä¼šæ‰§è¡Œã€‚</p>

<h3 id="æ¡ä»¶æ‰§è¡Œ-when">æ¡ä»¶æ‰§è¡Œ when</h3>

<p>Drone å…è®¸æœ‰æ¡ä»¶åœ°æ‰§è¡Œæ­¥éª¤ã€‚ä¸‹é¢çš„ä¾‹å­é™åˆ¶äº†å…è®¸ä½¿ç”¨ Slack æ’ä»¶çš„ Git åˆ†æ”¯ä¸º master:</p>

<pre><code class="language-yml">pipeline:
  slack:
    image: plugins/slack
    channel: dev
    when:
     branch: master
</code></pre>

<h3 id="æ•…éšœæ‰§è¡Œ-when-status">æ•…éšœæ‰§è¡Œ when + status</h3>

<p>Drone ä½¿ç”¨å®¹å™¨é€€å‡ºä»£ç æ¥å†³å®šä¸€ä¸ªæ„å»ºçš„æˆåŠŸæˆ–å¤±è´¥ã€‚é 0 é€€å‡ºä»£ç (Non-zero exit codes) ä½¿æ„å»ºå¤±è´¥ï¼ŒåŒæ—¶ç«‹å³é€€å‡ºå½“å‰å·¥ä½œæµã€‚</p>

<p>å¦‚æœéœ€è¦åœ¨æ„å»ºå¤±è´¥æ—¶ï¼Œæ‰§è¡Œç‰¹å®šçš„å·¥ä½œæµæ­¥éª¤ã€‚å¯ä»¥ä½¿ç”¨çŠ¶æ€æ¡ä»¶é™åˆ¶(status constraint) æ¥ä¿®æ”¹æ„å»ºå¤±è´¥æ—¶çš„é»˜è®¤è¡Œä¸ºå’Œæ‰§è¡Œæ­¥éª¤ã€‚</p>

<pre><code class="language-yml">pipeline:
  slack:
    image: plugins/slack
    channel: dev
    when:
     status: [success, failure]
</code></pre>

<h2 id="services">Services</h2>

<p><code>services</code> æ¨¡å—å®šä¹‰æœåŠ¡å®¹å™¨ï¼Œç”¨ç±»ä¼¼ docker-compose çš„è¯­æ³•ï¼Œæä¾›æœåŠ¡ä½œä¸º CI è¿‡ç¨‹ä¸­çš„æ”¯æ’‘ã€‚ä¸‹é¢çš„é…ç½®æ–‡ä»¶ç»„å»ºäº†æ•°æ®åº“æœåŠ¡å™¨å’Œç¼“å­˜æœåŠ¡å®¹å™¨ï¼š</p>

<pre><code class="language-yml">pipeline:
  build:
    image: golang:test
    commands:
      - go build 
      - go test

services:
  db-server:
    image: mysql

  cache-server
    image: redis
</code></pre>

<p>æœåŠ¡å®¹å™¨å¯ä»¥ä½¿ç”¨ YAML é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„åç§°æ¥è®¿é—®ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œmysql æœåŠ¡è¢«æŒ‡å®šä¸º db-server, å¯ä»¥ä½¿ç”¨ db-server:3306 æ¥è®¿é—®ã€‚</p>

<h3 id="é…ç½®">é…ç½®</h3>

<p>æœåŠ¡å®¹å™¨å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æ¥è‡ªå®šä¹‰ç”¨æˆ·åï¼Œå¯†ç å’Œç«¯å£ã€‚å…·ä½“æ”¯æŒçš„ç¯å¢ƒå˜é‡éœ€è¦å‚è€ƒå„ä¸ªæœåŠ¡çš„å®˜æ–¹é•œåƒæ–‡æ¡£ï¼Œå¦‚ MySQL æ•°æ®åº“éƒ¨åˆ†çš„é…ç½®å¦‚ä¸‹ï¼š</p>

<pre><code class="language-yml">services:
  database:
    image: mysql
    environment:
      - MYSQL_DATABASE=test
      - MYSQL_ALLOW_EMPTY_PASSWORD=yes
</code></pre>

<h3 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h3>

<p>æœåŠ¡å®¹å™¨éœ€è¦ä¸€å®šæ—¶é—´æ¥åˆå§‹åŒ–ï¼Œç„¶åæ‰èƒ½è¢«è®¿é—®ã€‚å¦‚æœåˆšå¼€å§‹æ— æ³•è¿æ¥åˆ°ä¸€ä¸ªæœåŠ¡ï¼Œå¯ä»¥å…ˆç­‰å¾…å‡ ç§’é’Ÿæˆ–è€…æ·»åŠ ä¸€ä¸ªé€€è®© (backoff) æœºåˆ¶ã€‚</p>

<pre><code class="language-yml">pipeline: 
  test:
    image: golang
    commands:
      - sleep 15
      - go get
      - go test

services:
  database:
    image:mysql
</code></pre>

<h2 id="plugins">Plugins</h2>

<p><code>Plugins</code> ä¹Ÿæ˜¯ Drone çš„æ ¸å¿ƒæ¦‚å¿µï¼ŒPlugins æ˜¯æ‰§è¡Œé¢„å®šä¹‰ä»»åŠ¡çš„å®¹å™¨ï¼Œå®ƒä»¬åœ¨å·¥ä½œæµä¸­è¢«é…ç½®ä¸ºæ­¥éª¤ (steps)ã€‚Drone é™¤äº† build å‘½ä»¤ä¹‹å¤–çš„åŠŸèƒ½åŸºæœ¬éƒ½é€šè¿‡æ’ä»¶å®Œæˆï¼Œä¾‹å¦‚éƒ¨ç½²ä»£ç ï¼Œå‘å¸ƒæ„å»ºç»“æœï¼ŒFTP(SSH)ä¸Šä¼ , å‘é€é€šçŸ¥ä»¥åŠéƒ¨ç½²å…¶ä»–æ›´å¤šçš„åŠŸèƒ½ã€‚å»ºè®®ç²¾è¯»å®˜æ–¹ç”¨äºæ„å»ºé•œåƒçš„ docker plugin çš„æ–‡æ¡£ï¼š<a href="http://plugins.drone.io/drone-plugins/drone-docker">http://plugins.drone.io/drone-plugins/drone-docker</a> , å¦å¤–ï¼Œgit æ˜¯ Drone é»˜è®¤çš„æ’ä»¶ï¼Œä¸éœ€è¦é…ç½®ã€‚</p>

<p>Docker å’Œ Slack æ’ä»¶å·¥ä½œæµç¤ºä¾‹ï¼š</p>

<pre><code class="language-yml">pipeline:
  build:
    image: golang
    commands:
      - go build
      - go test
  publish:
    image: plugins/docker
    repo: foo/bar
    tags: latest
  
  notify:
    image: plugins/slack
    channel: dev
</code></pre>

<h3 id="æ’ä»¶éš”ç¦»">æ’ä»¶éš”ç¦»</h3>

<p>æ’ä»¶åœ¨ Docker å®¹å™¨ä¸­æ‰§è¡Œï¼Œå®ƒä»¬ä¸å·¥ä½œæµä¸­çš„å…¶ä»–æ­¥éª¤ç›¸äº’éš”ç¦»ã€‚æ³¨æ„ï¼Œæ’ä»¶æŒ‚è½½å’Œå…±äº«å½“å‰å·¥ä½œåŒºï¼Œå› æ­¤å®ƒå°†å¯ä»¥è®¿é—®å¯¹åº”çš„æºä»£ç ã€‚</p>

<h3 id="æ’ä»¶å¸‚åœº">æ’ä»¶å¸‚åœº</h3>

<p>æ’ä»¶è¢«æ‰“åŒ…å’Œå‘å¸ƒä¸º Docker å®¹å™¨ï¼Œå®ƒä»¬åœ¨æ¦‚å¿µä¸Šå’Œè½¯ä»¶åº“ç±»ä¼¼(æ¯”å¦‚ npm), å¯ä»¥åœ¨ç¤¾åŒºä¸­å‘å¸ƒå’Œå…±äº«ã€‚å®˜æ–¹æ’ä»¶å¸‚åœºï¼š<a href="http://plugins.drone.io/">http://plugins.drone.io/</a></p>

<h2 id="deployments">Deployments</h2>

<p><code>Deployments</code> å‚æ•°å¯ä»¥è§¦å‘ Drone æ¥éƒ¨ç½²é¡¹ç›®ã€‚éƒ¨ç½²é¡¹ç›®åœ¨å·¥ä½œæµä¸­çš„äº‹ä»¶ç±»å‹ (event type) æ˜¯ deploymentã€‚å¯ä»¥ä½¿ç”¨äº‹ä»¶ç±»å‹ (event type) æˆ–è€…ç›®æ ‡ç¯å¢ƒå˜é‡ (target environment) æ¥é™åˆ¶æ‰§è¡Œçš„éƒ¨ç½²ã€‚</p>

<pre><code class="language-yml">pipeline:
  build:
    image: golang
    commands:
      - go build
      - go test

  publish:
    image: plugins/docker
    registry: registry.heroku.com
    repo: registry.heroku.com/my-staging-app/web
    when:
      event: deployment
      environment: staging

  publish_to_prod:
    image: plugins/docker
    registry: registry.heroku.com
    repo: registry.heroku.com/my-production-ap/web
    when:
      event: deployment
      environment: production
</code></pre>

<p>ä¸Šé¢çš„ä¾‹å­å±•ç¤ºäº†å¦‚ä½•é…ç½®å·¥ä½œæµæŒ‡å®šåœ¨ç‰¹å®šçš„ç›®æ ‡ç¯å¢ƒä¸­éƒ¨ç½²é¡¹ç›®ï¼Œæ¯”å¦‚ production ç”Ÿäº§ç¯å¢ƒã€‚</p>

<h3 id="è§¦å‘éƒ¨ç½²">è§¦å‘éƒ¨ç½²</h3>

<p>Drone ä¹Ÿæ”¯æŒä½¿ç”¨å‘½ä»¤è¡Œä»å·²æœ‰çš„æ„å»ºç»“æœä¸­è§¦å‘éƒ¨ç½²ã€‚è¿™ä¸ªè¡Œä¸ºä¸ä½¿ç”¨æ„å»ºç»“æœ(promoting builds) çš„æ¦‚å¿µç±»ä¼¼ã€‚</p>

<pre><code class="language-bash">$ drone deploy &lt;_repo_&gt; &lt;_build_&gt; &lt;_environment_&gt;
</code></pre>

<p>åœ¨å‡†ç”Ÿäº§ç¯å¢ƒï¼ˆstaging environmentï¼‰ä¸­ä½¿ç”¨æŸä¸€åºå·çš„æ„å»ºç»“æœã€‚</p>

<pre><code class="language-bash">$ drone deploy test/hello-world 24 staging
</code></pre>

<p>åœ¨ç”Ÿäº§ç¯å¢ƒï¼ˆproduction environmentï¼‰ä¸­ä½¿ç”¨æŸä¸€åºå·çš„æ„å»ºç»“æœã€‚</p>

<pre><code class="language-bash">$ drone deploy test/hello-world 24 production
</code></pre>

<h2 id="matrix-builds-çŸ©é˜µæ„å»º">Matrix Builds çŸ©é˜µæ„å»º</h2>

<p>Drone æ”¯æŒæ•´åˆçŸ©é˜µæ„å»ºã€‚Drone ä¸ºé…ç½®æ–‡ä»¶çŸ©é˜µä¸­çš„æ¯ä¸ªç»„åˆå„æ‰§è¡Œä¸€ä¸ªç‹¬ç«‹çš„æ„å»ºä»»åŠ¡ã€‚çŸ©é˜µæ„å»ºå…è®¸æ‚¨ä½¿ç”¨å¤šä¸ªé…ç½®æ¥æ„å»ºå’Œæµ‹è¯•ä¸€ä¸ªæäº¤(commit)ã€‚å®ƒæ›´é€‚ç”¨äºå¼€æºé¡¹ç›®å’Œ libs ç»´æŠ¤è€…ã€‚å¯ä»¥ä¸ºåŒä¸€ä¸ªç¯å¢ƒå˜é‡å£°æ˜å¤šç»„å€¼ï¼Œç¬›å¡å„¿ç§¯åè¿›è¡Œäº¤å‰æ„å»ºã€‚Matrix Builds å¯ä»¥åœ¨ .drone.yml æ–‡ä»¶é‡Œæ³¨å…¥ç¯å¢ƒå˜é‡ã€‚</p>

<p>çŸ©é˜µå®šä¹‰ç¤ºä¾‹ï¼š</p>

<pre><code class="language-yml">matrix:
  GO_VERSION:
    - 1.4
    - 1.3
  REDIS_VERSION:
    - 2.6
    - 2.8 
    - 3.0
</code></pre>

<p>åªåŒ…å«ç‰¹å®šç»„åˆçš„çŸ©é˜µç¤ºä¾‹ï¼š</p>

<pre><code class="language-yml">matrix:
  include:
    - GO_VERSION: 1.4
      REDIS_VERSION: 2.8
    - GO_VERSION: 1.5
      REDIS_VERSION: 2.8
    - GO_VERSION: 1.6
      REDIS_VERSION: 3.0
</code></pre>

<h3 id="å˜é‡æ’å€¼">å˜é‡æ’å€¼</h3>

<p>çŸ©é˜µå˜é‡å¯ä»¥ä½¿ç”¨ <code>${VARIABLE}</code> çš„è¯­æ³•æ¥è¿›è¡Œæ’å€¼ã€‚</p>

<pre><code class="language-yml">pipeline:
  build:
    image: golang:${GO_VERSION}
    commands:
      - go get
      - go build
      - go test

services:
  database:
    image: ${DATABASE}

matrix:
  GO_VERSION:
    - 1.4
    - 1.3
  DATABASE:
    - mysql:5.5
    - mysql:6.5
    - mariadb:10.1
</code></pre>

<p>æ’å…¥çŸ©é˜µå˜é‡åçš„ Yaml æ–‡ä»¶ç¤ºä¾‹ï¼š</p>

<pre><code class="language-yml">pipeline:
  build:
-   image: golang:${GO_VERSION}
   image: golang:1.4
    commands:
      - go get
      - go build
      - go test
   environment:
     - GO_VERSION=1.4
     - DATABASE=mysql:5.5

services:
  database:
-   image: ${DATABASE}
</code></pre>

<p>åŸºäº Docker é•œåƒæ ‡ç­¾ï¼ˆDocker image tagï¼‰çš„çŸ©é˜µæ„å»º</p>

<pre><code class="language-yml">pipeline:
  build:
    image: golang:${TAG}
    commands:
      - go build
      - go test

matrix:
  TAG:
    - 1.7
    - 1.8
    - latest
</code></pre>

<p>åŸºäº Docker é•œåƒçš„çŸ©é˜µæ„å»º</p>

<pre><code class="language-yml">pipeline:
  build:
    image: ${IMAGE}
    commands:
      - go build
      - go test

matrix:
  IMAGE:
    - golang:1.7
    - golang:1.8
    - golang:latest
</code></pre>

<p>ç¤ºä¾‹æ–‡ä»¶ï¼š.drone.yml</p>

<pre><code class="language-yml">workspace:
  base: /go
  path: src/gogs.finogeeks.com/baa-cicd
pipeline:
  build:
    image: golang:latest
    commands:
      - go build -o baa-cicd
  publish:
    image: plugins/docker
    registry: registry.finogeeks.com
    repo: registry.finogeeks.com/test/baa-cicd
    tags: latest
    secrets: [ docker_username, docker_password ]
    insecure: true
  notify:
    image: plugins/slack
    webhook: https://hooks.slack.com/services/xxx/xxx/xxx
    channel: dev
    template: &gt;
      {{#success build.status}}
        build {{build.number}} succeeded. Good job.
      {{else}}
        build {{build.number}} failed. Fix me please.
      {{/success}}
</code></pre>

<p>ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œpipeline ä¸­çš„ build éƒ¨åˆ†æ‰§è¡Œé¡¹ç›®çš„æ„å»ºï¼Œpublish éƒ¨åˆ†å°†é¡¹ç›®çš„ Docker é•œåƒå‘å¸ƒåˆ° registry, notify éƒ¨åˆ†å‘é€ slack æ¶ˆæ¯</p>

<h2 id="environment">Environment</h2>

<p>ç¯å¢ƒå˜é‡å¯ä»¥æŒ‰ç…§ç”Ÿæ•ˆä½ç½® (drone-server/drone-agent) åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œå…·ä½“åˆ°å¤šä¸ªä½¿ç”¨åœºæ™¯ï¼š</p>

<h3 id="drone-yml-é¢„è®¾çš„å˜é‡-å…±æœ‰ä¸¤å¤„">.drone.yml é¢„è®¾çš„å˜é‡ï¼Œå…±æœ‰ä¸¤å¤„ï¼š</h3>

<ul>
<li><p>è¿™äº›å˜é‡å¯ä»¥åœ¨ .drone.yml æ–‡ä»¶ä¸­ç›´æ¥ä»¥ ${XX_XX_XX} çš„æ ¼å¼ä½¿ç”¨ï¼Œå¹¶åœ¨ parsing é˜¶æ®µè¢«æ›¿æ¢ä¸ºå…·ä½“å€¼ã€‚è¿™ä¸ªè¡Œä¸ºå‘ç”Ÿåœ¨ drone-server é‡Œï¼Œå±äºæ„å»ºå‘¨æœŸçš„æœ€æ—©æœŸé˜¶æ®µã€‚
å®ƒä»¬åˆ†åˆ«æ˜¯:
drone ä¸ºä½¿ç”¨è€…é¢„è®¾çš„ç¯å¢ƒå˜é‡ï¼Œè¯¦ç»†å˜é‡åˆ—è¡¨è¯·å‚è€ƒ: <a href="http://docs.drone.io/environment-reference/">http://docs.drone.io/environment-reference/</a></p></li>

<li><p>matrix builds å£°æ˜çš„å˜é‡æ•°ç»„ã€‚
è¿™ä¸¤ç±»ç¯å¢ƒå˜é‡æš´éœ²å‡ºçš„ä¿¡æ¯å¾ˆæœ‰é™ï¼Œmatrix builds åªèƒ½æ˜¯å¸¸é‡ã€‚droneçš„é¢„è®¾å˜é‡é‡Œåªæœ‰ DRONE_COMMIT_MESSAGE å¯æ§ã€‚drone ä¼šå¯¹å…¶å‰åæ’å…¥åŒå¼•å·ï¼Œæœ«å°¾åŠ æ¢è¡Œç¬¦ï¼Œå†…å®¹é‡Œçš„ç‰¹æ®Šå­—ç¬¦åŠ è½¬ç§»ç­‰æ–¹å¼ä¿è¯ .drone.yml æ–‡ä»¶çš„å®‰å…¨æ€§å’Œé˜²æ³¨å…¥ã€‚</p></li>
</ul>

<h3 id="ci-å®¹å™¨ç«¯çš„å˜é‡">CI å®¹å™¨ç«¯çš„å˜é‡</h3>

<p>è¿™äº›å˜é‡æ˜¯ä½œç”¨åœ¨ drone-agent ç«¯ã€‚åŒ…æ‹¬:</p>

<ul>
<li><p>pipeline éƒ¨åˆ†çš„ environment å…³é”®å­—ï¼Œç±»ä¼¼ docker-compose. å½±å“ CI æ‰§è¡Œå®¹å™¨çš„è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ã€‚ç­‰æ•ˆäºåœ¨å®¹å™¨é‡Œæ‰§è¡Œ export XX=XXX</p></li>

<li><p>build_args å…³é”®å­—ï¼Œå½±å“ Dockerfile æ–‡ä»¶æœ¬èº«çš„ç¯å¢ƒå˜é‡ã€‚åœ¨ docker build è¿‡ç¨‹ä¸­ç”Ÿæ•ˆã€‚ç­‰æ•ˆäº Dockerfile é‡Œå£°æ˜ ARG å…³é”®å­—ï¼Œä¹Ÿç­‰æ•ˆäºæ„å»ºå‘½ä»¤ docker build &ndash;build-arg. å¸¸ç”¨åœºæ™¯ä¸»è¦æ˜¯ http_proxy å˜é‡ã€‚ å¦å¤– build_args(ARG) å¼•ç”³å‡ºçš„è¯é¢˜å±äº docker æœ¬èº«çš„èŒƒç•´ï¼Œéœ€è¦å¯¹ Dockerfile çš„ ARG å…³é”®å­—å’Œ ENV å…³é”®å­—è¦æœ‰æ‰€åŒºåˆ†ã€‚å®ƒä»¬å¤§è‡´ä¸Šæ— å¤ªå¤§å·®åˆ«ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯å˜é‡çš„ç”Ÿæ•ˆå‘¨æœŸï¼Œå‰è€…åœ¨ docker build æ‰§è¡ŒæœŸé—´ã€‚è€Œåè€…è¿˜ä¼š persist åˆ°äº§ç‰© image é‡Œã€‚</p></li>
</ul>

<p>è‡³æ­¤ï¼Œå®Œã€‚</p>

<h1 id="see-also">See Also</h1>

<blockquote>
<p>Thanks to the authors ğŸ™‚</p>
</blockquote>

<p>ç†è®ºç¯‡ï¼š</p>

<ul>
<li><a href="https://developer.finogeeks.com/topic/11/geekpipe-%E5%9F%BA%E4%BA%8Edrone%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E5%AE%9E%E8%B7%B5%E4%B9%8B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E7%AF%87">GeekPipe-åŸºäºDroneçš„æŒç»­é›†æˆå®è·µä¹‹åŸºæœ¬æ¦‚å¿µç¯‡</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/38223938">åˆ©ç”¨&rdquo;å…ƒç¼–ç¨‹&rdquo;å®ç°åŸºç¡€é•œåƒçš„é›†ä¸­ç®¡ç†å’ŒåŠ¨æ€æ„å»º (Drone CI 0.8)</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/38281927">å¿«é€Ÿç†è§£æŒç»­é›†æˆå·¥å…· Drone CI æ ¸å¿ƒæ¦‚å¿µ</a></li>
</ul>

<p>éƒ¨ç½²å®è·µç¯‡ï¼š</p>

<ul>
<li><a href="https://golangcaff.com/topics/111/drone-deployment-of-the-go-language-project-with-kubernetes">Drone æ­é… Kubernetes éƒ¨ç½² Go èªè¨€é …ç›®</a></li>
</ul>
    </div>

    
    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">zher</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2018-10-17</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/devops/">devops</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/tech/cloud/devops/20180926-cicd-03-practices/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">DevOps | CI/CD å®è·µ: Drone &#43; Docker &#43; Bitbucket Server</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/tech/cloud/docker/docker-compose-note/">
            <span class="next-text nav-default">Docker | Docker Compose åŸºç¡€</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  

  <div id="gitalk-container"></div>
  <link rel="stylesheet" href="/lib/gitalk/gitalk-1.2.2.min.css">
    <script src="/lib/gitalk/gitalk-1.2.2.min.js"></script>
  <script type="text/javascript">
  var gitalk = new Gitalk({
    id: '2018-09-25 00:00:00 \x2b0000 UTC',
    title: 'DevOps | Drone çš„åŸºæœ¬æ¦‚å¿µ',
    clientID: '4357c1dbcf7ef0515c29',
    clientSecret: '1ad00adfd9544bff956529daf898d4b81fed2a9d',
    repo: 'blog-comments',
    owner: 'zhezh09',
    admin: ['zhezh09'],
    body: decodeURI(location.href)
  });
  gitalk.render('gitalk-container');
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:zhezh.boy@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://www.facebook.com/zhe.zh.54" class="iconfont icon-facebook" title="facebook"></a>
      <a href="https://plus.google.com/u/0/103084907763171979239" class="iconfont icon-google" title="google"></a>
      <a href="https://github.com/zhezh09" class="iconfont icon-github" title="github"></a>
      <a href="https://weibo.com/p/1005053510554731/home?from=page_100505&amp;mod=TAB&amp;is_all=1#place" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/boy-zhe/activities" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.instagram.com/zher09/" class="iconfont icon-instagram" title="instagram"></a>
  <a href="https://zhezh09.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
    <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">zher</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-123995495-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
